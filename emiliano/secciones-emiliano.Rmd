---
title: "Secciones-emiliano"
output: html_document
date: "2024-11-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Seccion 1

```{r librerias}
library(shiny)
library(tidyverse)
library(DT)
library(scales)
```

## App shiny
```{r release}
library(shiny)
library(tidyverse)
library(DT)
library(scales)

# Helper function to format ID_PER consistently
format_id_per <- function(id) {
  as.character(sprintf("%.4f", as.numeric(id)))
}

# Helper function to create empty data message
create_empty_message <- function(filter_type) {
  div(
    style = "text-align: center; color: #666; padding: 20px;",
    h4("No hay datos disponibles"),
    p(paste("No se encontraron registros para", filter_type, "en Campeche")),
    p("Por favor seleccione otro filtro")
  )
}

# Custom theme for consistent plot styling
custom_theme <- function() {
  theme_minimal() +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5, margin = margin(b = 20)),
      plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 10)),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 10),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.title = element_text(size = 10, face = "bold"),
      legend.text = element_text(size = 9),
      legend.position = "bottom",
      panel.grid.major = element_line(color = "gray90"),
      panel.grid.minor = element_blank(),
      strip.text = element_text(size = 11, face = "bold")
    )
}

# Enhanced table formatting function
format_dt_table <- function(data) {
  datatable(
    data,
    options = list(
      dom = 't',
      ordering = FALSE,
      pageLength = -1,
      headerCallback = JS(
        "function(thead, data, start, end, display){",
        "  $(thead).css('background-color', '#f0f0f0');",
        "  $(thead).css('font-weight', 'bold');",
        "}"
      )
    ),
    rownames = FALSE,
    class = 'cell-border stripe hover'
  ) %>%
    formatStyle(
      columns = names(data),
      backgroundColor = styleEqual(c("0%", "100%"), c('#f8f9fa', '#e9ecef')),
      fontWeight = 'bold'
    )
}

# UI Components
ui <- fluidPage(
  titlePanel("Análisis de Antecedentes Familiares - ENPOL 2021"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("population_filter", "Filtrar por:",
                 choices = c("Todos",
                           "Mujeres",
                           "Mujeres Lengua Indígena",
                           "Mujeres Autoadscripción Indígena/Afro")),
      selectInput("state_filter", "Estado:",
                 choices = "Campeche")
    ),
    mainPanel(
      uiOutput("data_message"),
      
      tabsetPanel(
        tabPanel("Convivencia",
                plotOutput("living_situation_plot"),
                h4("Datos:"),
                DTOutput("living_situation_table")),
        tabPanel("Violencia/Precariedad",
                plotOutput("violence_plot"),
                h4("Datos:"),
                DTOutput("violence_table")),
        tabPanel("Percepción de Seguridad",
                plotOutput("security_plot"),
                h4("Datos:"),
                DTOutput("security_table"))
      )
    )
  )
)

server <- function(input, output, session) {
  # Load and merge data
  data <- reactive({
    main_data <- read.csv("../data/ENPOL2021_8_9_10_11.csv", encoding = "latin1") %>%
      mutate(ID_PER = format_id_per(ID_PER))
    
    soc_data <- read.csv("../data/ENPOL2021_SOC.csv", encoding = "latin1") %>%
      mutate(ID_PER = format_id_per(ID_PER))
    
    merged_data <- main_data %>%
      left_join(soc_data %>% select(ID_PER, P1_12, P1_15), 
                by = "ID_PER")
    
    return(merged_data)
  })
  
  # Filtered data
  filtered_data <- reactive({
    req(data())
    df <- data()
    
    result <- switch(input$population_filter,
                    "Todos" = df,
                    "Mujeres" = df %>% filter(SEXO == "2"),
                    "Mujeres Lengua Indígena" = df %>% 
                      filter(SEXO == "2", P1_12 == "1"),
                    "Mujeres Autoadscripción Indígena/Afro" = df %>% 
                      filter(SEXO == "2", P1_15 %in% c("1", "2")))
    
    result <- result %>% filter(NOM_ENT == "Campeche")
    
    print(paste("Filter:", input$population_filter))
    print(paste("Total records before Campeche filter:", nrow(df)))
    print(paste("Records in Campeche:", nrow(result)))
    
    return(result)
  })
  
  # Data availability message
  output$data_message <- renderUI({
    req(filtered_data())
    df <- filtered_data()
    
    if(nrow(df) == 0) {
      create_empty_message(input$population_filter)
    }
  })
  
  # Living Situation Plot
  output$living_situation_plot <- renderPlot({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    plot_data <- df %>%
      summarise(
        "Vivía con mamá" = mean(P9_8_1 == "1", na.rm = TRUE),
        "Vivía con papá" = mean(P9_8_2 == "1", na.rm = TRUE)
      ) %>%
      pivot_longer(everything(), names_to = "Situación", values_to = "Porcentaje")
    
    ggplot(plot_data, aes(x = Situación, y = Porcentaje, fill = Situación)) +
      geom_bar(stat = "identity", width = 0.7) +
      geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)), 
                position = position_stack(vjust = 0.5),
                size = 4, fontface = "bold") +
      scale_y_continuous(labels = scales::percent, limits = c(0, 1),
                        breaks = seq(0, 1, 0.2)) +
      scale_fill_brewer(palette = "Set2") +
      labs(title = "Convivencia Familiar en la Infancia",
           subtitle = paste("Filtro:", input$population_filter),
           y = "Porcentaje",
           x = "") +
      custom_theme()
  })
  
  # Violence Plot
  output$violence_plot <- renderPlot({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    plot_data <- df %>%
      summarise(
        "Presenció violencia" = mean(P9_10_3 == "1", na.rm = TRUE),
        "Perteneció a pandilla" = mean(P9_10_4 == "1", na.rm = TRUE)
      ) %>%
      pivot_longer(everything(), names_to = "Situación", values_to = "Porcentaje")
    
    ggplot(plot_data, aes(x = Situación, y = Porcentaje, fill = Situación)) +
      geom_bar(stat = "identity", width = 0.7) +
      geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)),
                position = position_stack(vjust = 0.5),
                size = 4, fontface = "bold") +
      scale_y_continuous(labels = scales::percent, limits = c(0, 1),
                        breaks = seq(0, 1, 0.2)) +
      scale_fill_brewer(palette = "Set3") +
      labs(title = "Experiencias de Violencia",
           subtitle = paste("Filtro:", input$population_filter),
           y = "Porcentaje",
           x = "") +
      custom_theme()
  })
  
  # Security Plot
  output$security_plot <- renderPlot({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    plot_data <- df %>%
      summarise(
        "Se sentía seguro" = mean(P9_10_1 == "1", na.rm = TRUE),
        "Vecinos se preocupaban" = mean(P9_10_2 == "1", na.rm = TRUE)
      ) %>%
      pivot_longer(everything(), names_to = "Situación", values_to = "Porcentaje")
    
    ggplot(plot_data, aes(x = Situación, y = Porcentaje, fill = Situación)) +
      geom_bar(stat = "identity", width = 0.7) +
      geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)),
                position = position_stack(vjust = 0.5),
                size = 4, fontface = "bold") +
      scale_y_continuous(labels = scales::percent, limits = c(0, 1),
                        breaks = seq(0, 1, 0.2)) +
      scale_fill_brewer(palette = "Set1") +
      labs(title = "Percepción de Seguridad",
           subtitle = paste("Filtro:", input$population_filter),
           y = "Porcentaje",
           x = "") +
      custom_theme()
  })
  
  # Tables with enhanced formatting
  output$living_situation_table <- renderDT({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    format_dt_table(df %>%
      summarise(
        "Vivía con mamá" = scales::percent(mean(P9_8_1 == "1", na.rm = TRUE), accuracy = 0.1),
        "Vivía con papá" = scales::percent(mean(P9_8_2 == "1", na.rm = TRUE), accuracy = 0.1)
      ))
  })
  
  output$violence_table <- renderDT({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    format_dt_table(df %>%
      summarise(
        "Presenció violencia" = scales::percent(mean(P9_10_3 == "1", na.rm = TRUE), accuracy = 0.1),
        "Perteneció a pandilla" = scales::percent(mean(P9_10_4 == "1", na.rm = TRUE), accuracy = 0.1)
      ))
  })
  
  output$security_table <- renderDT({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    format_dt_table(df %>%
      summarise(
        "Se sentía seguro" = scales::percent(mean(P9_10_1 == "1", na.rm = TRUE), accuracy = 0.1),
        "Vecinos se preocupaban" = scales::percent(mean(P9_10_2 == "1", na.rm = TRUE), accuracy = 0.1)
      ))
  })
}

shinyApp(ui = ui, server = server)
```

### Con mapas 
```{R}
library(shiny)
library(leaflet)
library(tidyverse)
library(DT)
library(scales)
library(leaflet.providers)

# UI Components
ui <- fluidPage(
  theme = bslib::bs_theme(version = 4),
  titlePanel("Maternidad y Salud en el Sistema Penitenciario Mexicano"),
  
  tabsetPanel(
    # First Page - Map and Graph
    tabPanel("Visualización Geográfica",
      fluidRow(
        column(12,
          p("Este análisis muestra la distribución y condiciones de las mujeres que viven con sus hijos en prisión 
            y aquellas que han sido diagnosticadas con enfermedades durante su reclusión.", 
            style = "font-size: 16px; margin: 20px 0;")
        )
      ),
      fluidRow(
        # Map and graph layout
        column(6,
          leafletOutput("map", height = 500)
        ),
        column(6,
          plotOutput("barPlot", height = 500)
        )
      ),
      fluidRow(
        column(12,
          p("* Haga clic en un estado del mapa para ver detalles específicos",
            style = "font-style: italic; color: #666; margin-top: 10px;")
        )
      )
    ),
    
    # Second Page - Interactive Table
    tabPanel("Datos Detallados",
      fluidRow(
        column(12,
          p("Explore los datos detallados sobre las condiciones de salud y maternidad en el sistema penitenciario.", 
            style = "font-size: 16px; margin: 20px 0;")
        )
      ),
      fluidRow(
        column(12,
          DTOutput("dataTable")
        )
      )
    )
  )
)

server <- function(input, output, session) {
  # Coordinates data
  coords <- data.frame(
    NOM_ENT = c("Aguascalientes", "Baja California", "Baja California Sur", "Campeche", "Chiapas",
                "Chihuahua", "Coahuila", "Colima", "Durango", "Guanajuato", "Guerrero", "Hidalgo",
                "Jalisco", "Estado de México", "Michoacán", "Morelos", "Nayarit", "Nuevo León",
                "Oaxaca", "Puebla", "Querétaro", "Quintana Roo", "San Luis Potosí", "Sinaloa",
                "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", "Veracruz", "Yucatán", "Zacatecas",
                "Ciudad de México"),
    lat = c(21.885, 32.526, 24.144, 19.832, 16.757, 28.635, 27.058, 19.123, 24.027, 20.917, 17.439, 20.091,
            20.659, 19.359, 19.566, 18.926, 21.751, 25.686, 17.071, 19.041, 20.588, 19.666, 22.158, 24.808,
            29.072, 18.003, 23.741, 19.313, 19.173, 20.709, 22.770, 19.432),
    lng = c(-102.291, -116.991, -110.299, -90.538, -93.113, -106.089, -101.706, -104.825, -104.653, -101.256,
            -99.543, -98.762, -103.348, -99.650, -101.189, -99.070, -104.895, -100.316, -96.721, -98.206,
            -100.393, -88.327, -100.987, -107.394, -110.974, -92.919, -98.998, -98.239, -96.142, -89.070,
            -102.583, -99.133)
  )

  # Reactive data
  data <- reactive({
    # Load and merge motherhood data
    data_mothers <- read.csv("../data/ENPOL2021_6.csv", encoding = "latin1") %>%
      filter(SEXO == 2) %>%  # Filter for women
      group_by(NOM_ENT) %>%
      summarise(total_mujeres = n(),
                mujeres_con_hijos = sum(P6_1 == 1, na.rm = TRUE))
    
    # Load and merge health data
    data_health <- read.csv("../data/ENPOL2021_SOC.csv", encoding = "latin1") %>%
      filter(SEXO == 2) %>%  # Filter for women
      group_by(NOM_ENT) %>%
      summarise(mujeres_enfermas = sum(P1_24_1 == 1, na.rm = TRUE))
    
    # Combine data
    data_combined <- data_mothers %>%
      left_join(data_health, by = "NOM_ENT") %>%
      left_join(coords, by = "NOM_ENT")
    
    return(data_combined)
  })
  
  # Selected state
  selected_state <- reactiveVal(NULL)
  
  # Map output
  output$map <- renderLeaflet({
  req(data())
  
  # Create a custom color palette with better scaled purples
  pal <- colorNumeric(
    palette = c("#F5F0F7", "#9B59B6", "#8E44AD", "#6C3483"), # Light to dark purple
    domain = data()$mujeres_con_hijos
  )
  
  # Adjust the radius scaling factor
  radius_scale <- function(x) {
    sqrt(x) * 1.5  # Reduced multiplier for smaller bubbles
  }
  
  leaflet(data()) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%  # Light background
    addCircleMarkers(
      lng = ~lng,
      lat = ~lat,
      radius = ~radius_scale(mujeres_con_hijos),  # Adjusted radius scaling
      color = ~pal(mujeres_con_hijos),
      fillOpacity = 0.7,
      stroke = TRUE,
      weight = 1,
      popup = ~sprintf(
        "<div style='padding: 10px; border-radius: 5px;'>
         <strong style='color: #4A235A;'>%s</strong><br/>
         <hr style='margin: 5px 0;'/>
         <b>Mujeres con hijos:</b> %d<br/>
         <b>Mujeres diagnosticadas:</b> %d<br/>
         <b>Total de mujeres:</b> %d<br/>
         <hr style='margin: 5px 0;'/>
         <b>Porcentaje con hijos:</b> %.1f%%<br/>
         <b>Porcentaje diagnosticadas:</b> %.1f%%</div>",
        NOM_ENT,
        mujeres_con_hijos,
        mujeres_enfermas,
        total_mujeres,
        mujeres_con_hijos/total_mujeres * 100,
        mujeres_enfermas/total_mujeres * 100
      ),
      layerId = ~NOM_ENT,
      label = ~NOM_ENT
    ) %>%
    addLegend(
      position = "bottomright",
      pal = pal,
      values = ~mujeres_con_hijos,
      title = "Mujeres con hijos",
      opacity = 0.7,
      labFormat = labelFormat(suffix = " mujeres")
    )
})
  
  # Observe map clicks
  observeEvent(input$map_marker_click, {
    selected_state(input$map_marker_click$id)
  })
  
  # Bar plot output
  output$barPlot <- renderPlot({
  req(data())
  
  plot_data <- data()
  
  if (!is.null(selected_state())) {
    plot_data <- plot_data %>%
      filter(NOM_ENT == selected_state())
  }
  
  ggplot(plot_data, aes(x = reorder(NOM_ENT, -mujeres_con_hijos))) +
    geom_bar(aes(y = mujeres_con_hijos, fill = "Mujeres con hijos"), 
             stat = "identity", alpha = 0.9) +
    geom_bar(aes(y = mujeres_enfermas, fill = "Mujeres diagnosticadas"), 
             stat = "identity", alpha = 0.7) +
    # Add data labels
    geom_text(aes(y = mujeres_con_hijos, 
                  label = mujeres_con_hijos),
              vjust = -0.5, 
              size = 3.5, 
              fontface = "bold") +
    geom_text(aes(y = mujeres_enfermas, 
                  label = mujeres_enfermas),
              vjust = 1.5, 
              size = 3.5, 
              fontface = "bold",
              color = "white") +
    scale_fill_manual(values = c("Mujeres con hijos" = "#8E44AD", 
                                "Mujeres diagnosticadas" = "#C0392B")) +
    labs(
      title = if (!is.null(selected_state())) {
        paste("Detalle de", selected_state())
      } else {
        "Distribución de Mujeres en el Sistema Penitenciario"
      },
      subtitle = if (!is.null(selected_state())) {
        paste("Total de mujeres:", 
              sum(plot_data$total_mujeres, na.rm = TRUE))
      } else {
        "Por Estado y Condición"
      },
      x = "Estado",
      y = "Número de Mujeres",
      fill = "Categoría"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, 
                              size = 16, 
                              face = "bold",
                              margin = margin(b = 10)),
      plot.subtitle = element_text(hjust = 0.5, 
                                 size = 12, 
                                 color = "gray40",
                                 margin = margin(b = 20)),
      axis.text.x = element_text(angle = 45, 
                               hjust = 1, 
                               size = 10),
      axis.text.y = element_text(size = 10),
      axis.title = element_text(size = 12, face = "bold"),
      legend.position = "bottom",
      legend.title = element_text(size = 11),
      legend.text = element_text(size = 10),
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      panel.grid.major.y = element_line(color = "gray90")
    ) +
    scale_y_continuous(
      expand = expansion(mult = c(0, 0.1)),
      labels = scales::comma
    )
  })
  
  # Interactive table output
  output$dataTable <- renderDT({
  req(data())
  
  formatted_data <- data() %>%
    select(
      Estado = NOM_ENT,
      `Total Mujeres` = total_mujeres,
      `Mujeres con Hijos` = mujeres_con_hijos,
      `Mujeres Diagnosticadas` = mujeres_enfermas
    ) %>%
    mutate(
      `% Con Hijos` = (`Mujeres con Hijos` / `Total Mujeres`),
      `% Diagnosticadas` = (`Mujeres Diagnosticadas` / `Total Mujeres`)
    )
  
  datatable(
    formatted_data,
    options = list(
      pageLength = 10,
      order = list(1, 'desc'),
      dom = 'lrtip',
      language = list(
        url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json'
      )
    ),
    rownames = FALSE,
    class = 'cell-border stripe hover',
    filter = 'top'
  ) %>%
    formatRound(c("Total Mujeres", "Mujeres con Hijos", "Mujeres Diagnosticadas"), 0) %>%
    formatPercentage(c("% Con Hijos", "% Diagnosticadas"), 2) %>%
    formatStyle(
      columns = c("% Con Hijos", "% Diagnosticadas"),
      background = styleColorBar(c(0, 1), "#8E44AD40"),
      backgroundSize = '98% 88%',
      backgroundRepeat = 'no-repeat',
      backgroundPosition = 'center'
    )
})
}

shinyApp(ui = ui, server = server)
```
---
# Seccion 8: 

```{R seccion8}
server <- function(input, output, session) {
  # Load data once at startup
  emp_data <- read.csv("../data/ENPOL2021_2_3.csv", encoding = "latin1")
  soc_data <- read.csv("../data/ENPOL2021_SOC.csv", encoding = "latin1")
  
  # Filter data
  filtered_data <- reactive({
    result <- emp_data
    
    if (input$population_filter == "women") {
      result <- result[result$SEXO == "2", ]
    } else if (input$population_filter == "indigenous") {
      indigenous_ids <- soc_data$ID_PER[soc_data$P1_12 == "1"]
      result <- result[result$SEXO == "2" & result$ID_PER %in% indigenous_ids, ]
    } else if (input$population_filter == "afro") {
      afro_ids <- soc_data$ID_PER[soc_data$P1_15 %in% c("1", "2")]
      result <- result[result$SEXO == "2" & result$ID_PER %in% afro_ids, ]
    }
    
    result
  })
  
  # Employment Status Plot (working version remains unchanged)
  output$status_plot <- renderPlot({
    df <- filtered_data()
    
    status_df <- data.frame(
      status = c("Trabajaban", "No Trabajaban", "Sin Respuesta"),
      count = c(
        sum(!is.na(df$P2_10) & df$P2_10 != "97", na.rm = TRUE),
        sum(df$P2_10 == "97", na.rm = TRUE),
        sum(is.na(df$P2_10))
      )
    )
    status_df$percentage <- status_df$count / sum(status_df$count)
    
    ggplot(status_df, aes(x = status, y = percentage, fill = status)) +
      geom_col() +
      geom_text(aes(label = scales::percent(percentage, accuracy = 0.1)),
                position = position_stack(vjust = 1.1)) +
      scale_y_continuous(labels = scales::percent) +
      scale_fill_brewer(palette = "Set2") +
      labs(title = "Estado Laboral Previo a la Detención",
           subtitle = case_when(
             input$population_filter == "all" ~ "Población Total",
             input$population_filter == "women" ~ "Mujeres",
             input$population_filter == "indigenous" ~ "Mujeres Lengua Indígena",
             input$population_filter == "afro" ~ "Mujeres Autoadscripción Indígena/Afro"
           ),
           x = "",
           y = "Porcentaje") +
      theme_minimal() +
      theme(
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.text = element_text(size = 12)
      )
  })
  
  # Define a function to categorize occupations
  categorize_occupation <- function(occupation) {
    occupation <- tolower(occupation)  # Convert to lowercase for easier matching
    
    if (grepl("comercio|comerciante|tienda", occupation)) {
      return("Commerce")
    } else if (grepl("campo|agricultor|cosecha|agricola|piña|limones", occupation)) {
      return("Agriculture")
    } else if (grepl("construccion|albañil|mantenimiento", occupation)) {
      return("Construction")
    } else if (grepl("empleado|trabajador|jefe", occupation)) {
      return("Services")
    } else if (grepl("mecánico|carpintero|pintor", occupation)) {
      return("Skilled Trades")
    } else if (grepl("seguridad|policía|guardia", occupation)) {
      return("Security")
    } else if (grepl("no trabaja|no responde", occupation)) {
      return("Unemployed")
    } else {
      return("Other")
    }
  }
  
  # Occupations Plot
  output$occupations_plot <- renderPlot({
    df <- filtered_data()
    
    # Debugging: Check filtered data structure
    if (nrow(df) == 0 || is.null(df$P2_10)) {
      plot.new()
      text(0.5, 0.5, "No data available for occupations", cex = 1.2)
      return()
    }
    
    # Apply categorization
    df$Category <- sapply(as.character(df$P2_10), categorize_occupation)
    
    # Debugging: Check categories
    if (all(is.na(df$Category))) {
      plot.new()
      text(0.5, 0.5, "No valid categories for occupations", cex = 1.2)
      return()
    }
    
    # Aggregate data
    category_counts <- table(df$Category)
    percentages <- as.numeric(category_counts) / sum(category_counts)
    names(percentages) <- names(category_counts)
    
    # Sort in descending order
    percentages <- sort(percentages, decreasing = TRUE)
    
    # Adjust margins for labels
    par(mar = c(5, 15, 4, 2))
    
    # Create plot
    plot(
      percentages,
      seq_along(percentages),
      type = "n",
      xlab = "Porcentaje del Total",
      ylab = "",
      main = "Distribución de Ocupaciones",
      axes = FALSE,
      xlim = c(0, max(percentages) * 1.3),
      ylim = c(0.5, length(percentages) + 0.5)
    )
    
    # Add axes and labels
    axis(1)
    axis(2, at = seq_along(percentages), labels = names(percentages), las = 1, cex.axis = 0.8)
    
    # Add lollipop chart
    segments(0, seq_along(percentages), percentages, seq_along(percentages), col = "#8E44AD", lwd = 2)
    points(percentages, seq_along(percentages), pch = 16, col = "#8E44AD", cex = 1.5)
    text(percentages + 0.02, seq_along(percentages), 
         labels = sprintf("%.1f%% (%d personas)", percentages * 100, as.numeric(category_counts)), 
         pos = 4, cex = 0.8)
  })

  # Enhanced Income Sources Plot
  # Income Sources Plot with Fixed Y-Axis Labels
  output$income_plot <- renderPlot({
    df <- filtered_data()
    
    # Check if data is available
    if (nrow(df) == 0 || is.null(df$P2_13)) {
      plot.new()
      text(0.5, 0.5, "No data available for income sources", cex = 1.2)
      return()
    }
    
    # Aggregate data correctly and filter out 98, 99 codes
    income_sources <- df %>%
      filter(!is.na(P2_13), 
             !P2_13 %in% c("98", "99")) %>%  # Filter out no sabe/no responde
      count(P2_13) %>%
      arrange(desc(n))
    
    if (nrow(income_sources) == 0) {
      plot.new()
      text(0.5, 0.5, "No data available for income sources", cex = 1.2)
      return()
    }
    
    # Calculate percentages
    total_responses <- sum(income_sources$n)
    income_sources <- income_sources %>%
      mutate(percentage = n / total_responses)
    
    # Define descriptions
    descriptions <- c(
        "01" = "Un familiar o amigo(a) me daba dinero",
        "02" = "Vendía o realizaba algún producto para su venta",
        "03" = "Ofrecía algún servicio a cambio de un pago",
        "04" = "Trabajaba en tierras propias o ayudando",
        "05" = "Recibía apoyo de un programa de gobierno",
        "06" = "Negocios chuecos, al 'bisne', actividades ilegales",
        "07" = "Vivía de mis ahorros",
        "08" = "Otra actividad"
    )
    
    # Create layout with extra space at bottom for legend
    layout(matrix(c(1,2), nrow=2, ncol=1), heights=c(4,1))
    
    # Set up the main plot
    par(mar = c(5, 8, 4, 8))
    
    # Create the base plot
    plot(income_sources$percentage,
         seq_along(income_sources$percentage),
         type = "n",
         xlab = "Porcentaje del Total",
         ylab = "",
         main = "Distribución de Fuentes de Ingreso",
         axes = FALSE,
         xlim = c(0, max(income_sources$percentage) * 1.2),
         ylim = c(0.5, nrow(income_sources) + 0.5))
    
    # Add horizontal lines and points
    segments(0, seq_along(income_sources$percentage), 
             income_sources$percentage, seq_along(income_sources$percentage), 
             col = "#2E86C1", 
             lwd = 2)
    points(income_sources$percentage, seq_along(income_sources$percentage), 
           pch = 16, 
           col = "#2E86C1", 
           cex = 1.5)
    
    # Add x-axis
    axis(1, at = pretty(c(0, max(income_sources$percentage))), 
         labels = paste0(pretty(c(0, max(income_sources$percentage))) * 100, "%"))
    
    # Add y-axis with codes
    axis(2, at = seq_along(income_sources$percentage), 
         labels = sprintf("%02d", as.numeric(income_sources$P2_13)), 
         las = 2,
         cex.axis = 0.8)
    
    # Add count labels on the right
    text(income_sources$percentage, 
         seq_along(income_sources$percentage), 
         sprintf(" %.1f%% (%d personas)", 
                 income_sources$percentage * 100, 
                 income_sources$n),
         pos = 4,
         cex = 0.8)
    
    # Create legend plot
    par(mar = c(0, 2, 0, 2))
    plot.new()
    plot.window(xlim = c(0, 1), ylim = c(0, 1))
    
    # Split descriptions into two columns with more space for text
    n_desc <- length(descriptions)
    mid_point <- ceiling(n_desc/2)
    
    # First column of descriptions (moved more to the left)
    text(0.02, seq(0.8, 0.2, length.out = mid_point), 
         sprintf("%02d - %s", 1:mid_point, descriptions[1:mid_point]),
         cex = 0.8, pos = 4, adj = 0)
    
    # Second column of descriptions (starting closer to middle)
    text(0.52, seq(0.8, 0.2, length.out = n_desc - mid_point), 
         sprintf("%02d - %s", (mid_point+1):n_desc, descriptions[(mid_point+1):n_desc]),
         cex = 0.8, pos = 4, adj = 0)
    
  }, height = 600)
}

shinyApp(ui = ui, server = server)
```

---
# Seccion 11

```{R}
library(shiny)
library(tidyverse)
library(DT)
library(scales)

ui <- fluidPage(
  theme = bslib::bs_theme(version = 4),
  titlePanel("Análisis de Acceso a la Educación - ENPOL 2021"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("population_filter", "Filtrar por:",
                 choices = c("Todos",
                           "Mujeres",
                           "Mujeres Lengua Indígena",
                           "Mujeres Autoadscripción Indígena/Afro")),
      selectInput("state_filter", "Estado:",
                 choices = "Campeche")
    ),
    
    mainPanel(
      tabsetPanel(
        # Educational Level Tab
        tabPanel("Nivel Educativo",
                plotOutput("education_level_plot", height = "600px"),
                DTOutput("education_level_table")),
        
        # Prison Education Tab
        tabPanel("Educación en Prisión",
                plotOutput("prison_education_plot", height = "600px"),
                DTOutput("prison_education_table")),
        
        # Dropout Reasons Tab
        tabPanel("Razones de Abandono",
                plotOutput("dropout_reasons_plot", height = "600px"),
                DTOutput("dropout_reasons_table"))
      )
    )
  )
)

server <- function(input, output, session) {
  # Load and process data
  data <- reactive({
    edu_data <- read.csv("../data/ENPOL2021_SOC.csv", encoding = "latin1")
    
    filtered <- switch(input$population_filter,
      "Todos" = edu_data,
      "Mujeres" = edu_data %>% filter(SEXO == "2"),
      "Mujeres Lengua Indígena" = edu_data %>% 
        filter(SEXO == "2", P1_12 == "1"),
      "Mujeres Autoadscripción Indígena/Afro" = edu_data %>% 
        filter(SEXO == "2", P1_15 %in% c("1", "2"))
    )
    
    filtered %>% filter(NOM_ENT == "Campeche")
  })

  output$education_level_plot <- renderPlot({
    req(data())
    
    # Define education levels mapping
    education_levels <- c(
      "0" = "Sin educación",
      "1" = "Preescolar",
      "2" = "Primaria", 
      "3" = "Secundaria",
      "4" = "Carrera técnica (secundaria)",
      "5" = "Normal básica",
      "6" = "Preparatoria",
      "7" = "Carrera técnica (preparatoria)", 
      "8" = "Licenciatura",
      "9" = "Posgrado",
      "98" = "No sabe",
      "99" = "No responde"
    )
    
    plot_data <- data() %>%
      count(P1_18_N) %>%  # Changed from P1_18 to P1_18_N
      mutate(
        level = case_when(
          as.character(P1_18_N) %in% names(education_levels) ~ education_levels[as.character(P1_18_N)],
          TRUE ~ "No especificado"
        ),
        percentage = n/sum(n) * 100
      ) %>%
      arrange(desc(percentage))
    
    ggplot(plot_data, aes(x = reorder(level, percentage), y = percentage)) +
      geom_bar(stat = "identity", fill = "#2E86C1", width = 0.7) +
      geom_text(aes(label = sprintf("%.1f%%", percentage)),
                hjust = -0.2) +
      scale_y_continuous(limits = c(0, max(plot_data$percentage) * 1.2)) +
      coord_flip() +
      labs(
        title = "Distribución por Nivel Educativo",
        subtitle = paste("Filtro:", input$population_filter),
        x = "",
        y = "Porcentaje"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12)
      )
  })

  # Prison Education Plot
  output$prison_education_plot <- renderPlot({
    req(data())
    
    plot_data <- data() %>%
      count(P1_19) %>%
      mutate(
        status = case_when(
          P1_19 == "1" ~ "Estudiando",
          P1_19 == "2" ~ "No estudiando",
          TRUE ~ "Sin información"
        ),
        percentage = n/sum(n) * 100
      )
    
    ggplot(plot_data, aes(x = status, y = percentage, fill = status)) +
      geom_bar(stat = "identity", width = 0.7) +
      geom_text(aes(label = sprintf("%.1f%%", percentage)),
                position = position_stack(vjust = 0.5),
                size = 5) +
      scale_fill_manual(values = c("#2E86C1", "#E74C3C", "#95A5A6")) +
      labs(
        title = "Participación en Programas Educativos",
        subtitle = paste("Filtro:", input$population_filter),
        x = "",
        y = "Porcentaje"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        legend.position = "none",
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12)
      )
  })

  # Dropout Reasons Plot
  output$dropout_reasons_plot <- renderPlot({
    req(data())
    
    reasons <- c(
      "01" = "No quise/No me interesa",
      "02" = "Dificultad académica",
      "03" = "Otras actividades",
      "04" = "Actividades ilegales",
      "05" = "Falta de dinero",
      "06" = "Expulsión",
      "07" = "Trabajo",
      "08" = "Falta de documentos",
      "09" = "Matrimonio/Embarazo",
      "10" = "Detención",
      "11" = "Salida de cárcel",
      "12" = "Labores del hogar",
      "13" = "Salud",
      "14" = "Adicciones"
    )
    
    plot_data <- data() %>%
      count(P1_21) %>%
      mutate(
        reason = reasons[P1_21],
        percentage = n/sum(n) * 100
      ) %>%
      arrange(desc(percentage))
    
    ggplot(plot_data, aes(x = reorder(reason, percentage), y = percentage)) +
      geom_bar(stat = "identity", fill = "#2E86C1", width = 0.7) +
      geom_text(aes(label = sprintf("%.1f%%", percentage)),
                hjust = -0.2) +
      scale_y_continuous(limits = c(0, max(plot_data$percentage) * 1.2)) +
      coord_flip() +
      labs(
        title = "Razones para Abandonar los Estudios",
        subtitle = paste("Filtro:", input$population_filter),
        x = "",
        y = "Porcentaje"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12)
      )
  })

  # Enhanced table outputs
  output$education_level_table <- renderDT({
    req(data())
    
    data() %>%
      count(P1_18) %>%
      mutate(
        Porcentaje = n/sum(n) * 100,
        Porcentaje = sprintf("%.1f%%", Porcentaje)
      ) %>%
      datatable(
        options = list(
          pageLength = 10,
          dom = 't',
          ordering = FALSE
        ),
        rownames = FALSE
      )
  })

  output$prison_education_table <- renderDT({
    req(data())
    
    data() %>%
      count(P1_19) %>%
      mutate(
        Status = case_when(
          P1_19 == "1" ~ "Estudiando",
          P1_19 == "2" ~ "No estudiando",
          TRUE ~ "Sin información"
        ),
        Porcentaje = n/sum(n) * 100,
        Porcentaje = sprintf("%.1f%%", Porcentaje)
      ) %>%
      select(Status, n, Porcentaje) %>%
      datatable(
        options = list(
          pageLength = 10,
          dom = 't',
          ordering = FALSE
        ),
        rownames = FALSE
      )
  })

  output$dropout_reasons_table <- renderDT({
    req(data())
    
    data() %>%
      count(P1_21) %>%
      mutate(
        Porcentaje = n/sum(n) * 100,
        Porcentaje = sprintf("%.1f%%", Porcentaje)
      ) %>%
      datatable(
        options = list(
          pageLength = 10,
          dom = 't',
          ordering = FALSE
        ),
        rownames = FALSE
      )
  })
}

shinyApp(ui = ui, server = server)
```
