---
title: "Secciones-emiliano"
output: html_document
date: "2024-11-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
---
# Dashboard Final

```{R final}
library(shiny)
library(tidyverse)
library(DT)
library(scales)
library(leaflet)
library(bslib)
library(leaflet.providers)

# UI 
ui <- navbarPage(
  id = "mainNavbar",  # Add this ID for navigation
  title = "Análisis del Sistema Penitenciario",
  theme = bs_theme(version = 4),
  
  # Introduction Page with Fixed Navigation
  tabPanel("Inicio",
    fluidRow(
      column(12, 
        div(
          style = "padding: 20px; text-align: center;",
          h1("Análisis del Sistema Penitenciario en México"),
          p("Un estudio basado en la Encuesta Nacional de Población Privada de la Libertad 2021"),
          hr()
        )
      )
    ),
    fluidRow(
      column(12,
        div(
          style = "padding: 20px;",
          h3("Secciones del Análisis"),
          
          # Navigation Cards with Fixed Links
          div(
            style = "display: flex; flex-wrap: wrap; justify-content: space-around;",
            
            # Section 1: Family Background card
            div(
              class = "card",
              style = "width: 18rem; margin: 10px;",
              div(
                class = "card-body",
                h5(class = "card-title", "1. Antecedentes Familiares"),
                p(class = "card-text", "Análisis de la convivencia familiar y situaciones de violencia en la infancia."),
                actionButton("goto_section1", "Explorar",
                            class = "btn btn-primary w-100",
                            style = "margin-top: 10px;")
              )
            ),
            
            # Section 8: Work History card
            div(
              class = "card",
              style = "width: 18rem; margin: 10px;",
              div(
                class = "card-body",
                h5(class = "card-title", "8. Historial Laboral"),
                p(class = "card-text", "Análisis del empleo y fuentes de ingresos previos a la detención."),
                actionButton("goto_section8", "Explorar",
                            class = "btn btn-primary w-100",
                            style = "margin-top: 10px;")
              )
            ),
            
            # Section 11: Education Access card
            div(
              class = "card",
              style = "width: 18rem; margin: 10px;",
              div(
                class = "card-body",
                h5(class = "card-title", "11. Acceso a Educación"),
                p(class = "card-text", "Análisis de niveles educativos y razones de abandono escolar."),
                actionButton("goto_section11", "Explorar",
                            class = "btn btn-primary w-100",
                            style = "margin-top: 10px;")
              )
            ),
            
            
            # Replace the Section 13 card in the homepage with:
            div(
              class = "card",
              style = "width: 18rem; margin: 10px;",
              div(
                class = "card-body",
                h5(class = "card-title", "13. Expectativas de Vivienda"),
                p(class = "card-text", "Análisis de perspectivas de vivienda post-liberación."),
                actionButton("goto_section13", "Explorar",
                            class = "btn btn-primary w-100",
                            style = "margin-top: 10px;")
              )
            ),
            
          )
        )
      )
    )
  ),
  
  # Section 1: Family Background
  tabPanel("Antecedentes Familiares",
    sidebarLayout(
      sidebarPanel(
        selectInput("population_filter", "Filtrar por:",
          choices = c("Todos", "Mujeres", "Mujeres Lengua Indígena", "Mujeres Autoadscripción Indígena/Afro")),
        selectInput("state_filter", "Estado:", choices = "Campeche")
      ),
      mainPanel(
        tabsetPanel(
          tabPanel("Convivencia",
            plotOutput("living_situation_plot"),
            DTOutput("living_situation_table")),
          tabPanel("Violencia/Precariedad",
            plotOutput("violence_plot"),
            DTOutput("violence_table")),
          tabPanel("Percepción de Seguridad",
            plotOutput("security_plot"),
            DTOutput("security_table"))
        )
      )
    )
  ),
  
  # Section 8: Work History
  tabPanel("Historial Laboral",
    titlePanel("Análisis de Empleo"),
    sidebarLayout(
      sidebarPanel(
        selectInput("work_filter", "Filtrar por:",
          choices = c("Todos" = "all", "Mujeres" = "women", "Mujeres Lengua Indígena" = "indigenous", "Mujeres Autoadscripción Indígena/Afro" = "afro"))
      ),
      mainPanel(
        tabsetPanel(
          tabPanel("Estado Laboral", 
            plotOutput("status_plot"),
            tags$div(
              style = "margin-top: 20px;",
              helpText("Distribución de la situación laboral previa a la detención")
            )),
          tabPanel("Ocupaciones", 
            plotOutput("occupations_plot"),
            tags$div(
              style = "margin-top: 20px;",
              helpText("Categorización de ocupaciones principales")
            ))
        )
      )
    )
  ),
  
  # Section 11: Education Access
  tabPanel("Acceso a Educación",
    sidebarLayout(
      sidebarPanel(
        selectInput("edu_population_filter", "Filtrar por:",
          choices = c("Todos", "Mujeres", "Mujeres Lengua Indígena", "Mujeres Autoadscripción Indígena/Afro")),
        selectInput("edu_state_filter", "Estado:", choices = "Campeche")
      ),
      mainPanel(
        tabsetPanel(
          tabPanel("Nivel Educativo",
            plotOutput("education_level_plot"),
            DTOutput("education_level_table")),
          tabPanel("Educación en Prisión",
            plotOutput("prison_education_plot"),
            DTOutput("prison_education_table")),
          tabPanel("Razones de Abandono",
            plotOutput("dropout_reasons_plot"),
            DTOutput("dropout_reasons_table"))
        )
      )
    )
  ),
  
# Expectativas de Vivienda
tabPanel("Expectativas de Vivienda",
  titlePanel("Expectativas de Vivienda Post-Liberación"),
  sidebarLayout(
    sidebarPanel(
      width = 3,
      selectInput("housing_filter", "Filtrar por:",
        choices = c("Todos" = "all", 
                   "Mujeres" = "women", 
                   "Mujeres Lengua Indígena" = "indigenous", 
                   "Mujeres Autoadscripción Indígena/Afro" = "afro")),
      hr(),
      helpText("Esta sección analiza las expectativas de vivienda de las personas privadas de libertad al momento de su liberación.")
    ),
    mainPanel(
      width = 9,
      tabsetPanel(
        type = "tabs",
        tabPanel("Lugar para Vivir",
          plotOutput("housing_availability_plot", height = "400px"),
          DTOutput("housing_availability_table")
        ),
        tabPanel("Vivienda Anterior",
          plotOutput("previous_housing_plot", height = "400px"),
          DTOutput("previous_housing_table")
        )
      )
    )
  )
),
  
)

# Server logic implementation
server <- function(input, output, session) {
  # Navigation observers
  observeEvent(input$goto_section1, {
    req(input$goto_section1)
    req(session)
    message("Attempting navigation to Antecedentes Familiares")
    updateNavbarPage(session, inputId = "mainNavbar", selected = "Antecedentes Familiares")
  }, ignoreInit = TRUE)
  
  observeEvent(input$goto_section8, {
    req(input$goto_section8)
    req(session)
    message("Attempting navigation to Historial Laboral")
    updateNavbarPage(session, inputId = "mainNavbar", selected = "Historial Laboral")
  }, ignoreInit = TRUE)
  
  observeEvent(input$goto_section11, {
    req(input$goto_section11)
    req(session)
    message("Attempting navigation to Acceso a Educación")
    updateNavbarPage(session, inputId = "mainNavbar", selected = "Acceso a Educación")
  }, ignoreInit = TRUE)
  
  # Add this navigation observer to the server section (with the other observers):
observeEvent(input$goto_section13, {
  req(input$goto_section13)
  req(session)
  message("Attempting navigation to Expectativas de Vivienda")
  updateNavbarPage(session, inputId = "mainNavbar", selected = "Expectativas de Vivienda") 
}, ignoreInit = TRUE)
  
  # Add error handling for navigation
  onStop(function() {
    message("Session ended")
  })
  
  # Data Loading ----
# Add this debug function to your server
print_data_summary <- function(df, section) {
  cat("\nData summary for", section, ":\n")
  cat("Total rows:", nrow(df), "\n")
  cat("Women:", sum(df$SEXO == "2"), "\n")
  cat("Indigenous women:", sum(df$SEXO == "2" & df$P1_12 == "1", na.rm = TRUE), "\n")
  cat("Afro women:", sum(df$SEXO == "2" & df$P1_15 %in% c("1", "2"), na.rm = TRUE), "\n")
}

# Update the data loading section
data_main <- reactive({
  main_data <- read.csv("../data/ENPOL2021_8_9_10_11.csv", encoding = "latin1") %>%
    mutate(ID_PER = sprintf("%.4f", as.numeric(ID_PER)))
  
  soc_data <- read.csv("../data/ENPOL2021_SOC.csv", encoding = "latin1") %>%
    mutate(
      ID_PER = sprintf("%.4f", as.numeric(ID_PER)),
      P1_12 = as.character(P1_12),
      P1_15 = as.character(P1_15)
    )
  
  emp_data <- read.csv("../data/ENPOL2021_2_3.csv", encoding = "latin1") %>%
    mutate(ID_PER = sprintf("%.4f", as.numeric(ID_PER)))
  
  # Join the datasets
  main_data <- main_data %>%
    left_join(soc_data %>% select(ID_PER, P1_12, P1_15), by = "ID_PER")
  
  emp_data <- emp_data %>%
    left_join(soc_data %>% select(ID_PER, P1_12, P1_15), by = "ID_PER")
  
  # Print debug information
  print_data_summary(main_data, "Main data")
  print_data_summary(emp_data, "Employment data")
  print_data_summary(soc_data, "Social data")
  
  list(
    main = main_data,
    soc = soc_data,
    emp = emp_data
  )
})
  
  # Section 1: Antecedentes Familiares
  filtered_data_sec1 <- reactive({
    req(data_main())
    df <- data_main()$main
    
    result <- switch(input$population_filter,
      "Todos" = df,
      "Mujeres" = df %>% filter(SEXO == "2"),
      "Mujeres Lengua Indígena" = df %>% 
        filter(SEXO == "2", !is.na(P1_12), P1_12 == "1") %>%
        {if(nrow(.) == 0) stop("No hay datos disponibles para mujeres con lengua indígena") else .},
      "Mujeres Autoadscripción Indígena/Afro" = df %>% 
        filter(SEXO == "2", !is.na(P1_15), P1_15 %in% c("1", "2")))
    
    result %>% 
      filter(NOM_ENT == "Campeche") %>%
      {if(nrow(.) == 0) stop("No hay datos disponibles para los filtros seleccionados") else .}
  })
  
  # Living Situation Plot
  output$living_situation_plot <- renderPlot({
    req(filtered_data_sec1())
    df <- filtered_data_sec1()
    
    plot_data <- df %>%
      summarise(
        "Vivía con mamá" = mean(P9_8_1 == "1", na.rm = TRUE),
        "Vivía con papá" = mean(P9_8_2 == "1", na.rm = TRUE)
      ) %>%
      pivot_longer(everything(), names_to = "Situación", values_to = "Porcentaje")
    
    ggplot(plot_data, aes(x = Situación, y = Porcentaje, fill = Situación)) +
      geom_bar(stat = "identity", width = 0.7) +
      geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)), 
                position = position_stack(vjust = 0.5)) +
      scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
      scale_fill_brewer(palette = "Set2") +
      labs(title = "Convivencia Familiar en la Infancia",
           subtitle = paste("Filtro:", input$population_filter),
           y = "Porcentaje") +
      theme_minimal() +
      theme(legend.position = "none")
  })
  
  # Violence Plot
output$violence_plot <- renderPlot({
  req(filtered_data_sec1())
  df <- filtered_data_sec1()
  
  plot_data <- df %>%
    summarise(
      "Presenció violencia" = mean(P9_10_3 == "1", na.rm = TRUE),
      "Perteneció a pandilla" = mean(P9_10_4 == "1", na.rm = TRUE)
    ) %>%
    pivot_longer(everything(), names_to = "Situación", values_to = "Porcentaje")
  
  ggplot(plot_data, aes(x = Situación, y = Porcentaje, fill = Situación)) +
    geom_bar(stat = "identity", width = 0.7) +
    geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)),
              position = position_stack(vjust = 0.5),
              size = 4, fontface = "bold") +
    scale_y_continuous(labels = scales::percent, limits = c(0, 1),
                      breaks = seq(0, 1, 0.2)) +
    scale_fill_brewer(palette = "Set3") +
    labs(title = "Experiencias de Violencia",
         subtitle = paste("Filtro:", input$population_filter),
         y = "Porcentaje",
         x = "") +
    theme_minimal() +
    theme(legend.position = "none")
})

# Security Plot
output$security_plot <- renderPlot({
  req(filtered_data_sec1())
  df <- filtered_data_sec1()
  
  plot_data <- df %>%
    summarise(
      "Se sentía seguro" = mean(P9_10_1 == "1", na.rm = TRUE),
      "Vecinos se preocupaban" = mean(P9_10_2 == "1", na.rm = TRUE)
    ) %>%
    pivot_longer(everything(), names_to = "Situación", values_to = "Porcentaje")
  
  ggplot(plot_data, aes(x = Situación, y = Porcentaje, fill = Situación)) +
    geom_bar(stat = "identity", width = 0.7) +
    geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)),
              position = position_stack(vjust = 0.5),
              size = 4, fontface = "bold") +
    scale_y_continuous(labels = scales::percent, limits = c(0, 1),
                      breaks = seq(0, 1, 0.2)) +
    scale_fill_brewer(palette = "Set1") +
    labs(title = "Percepción de Seguridad",
         subtitle = paste("Filtro:", input$population_filter),
         y = "Porcentaje",
         x = "") +
    theme_minimal() +
    theme(legend.position = "none")
})

  
# Update the filtered_data_sec8 reactive in your server
filtered_data_sec8 <- reactive({
  req(data_main())
  df <- data_main()$emp
  
  result <- switch(input$work_filter,
    "all" = df,
    "women" = df %>% filter(SEXO == "2"),
    "indigenous" = {
      filtered <- df %>% 
        filter(SEXO == "2") %>%
        inner_join(data_main()$soc %>% 
                    filter(P1_12 == "1") %>% 
                    select(ID_PER),
                  by = "ID_PER")
      if(nrow(filtered) == 0) {
        return(data.frame())  # Return empty dataframe instead of NULL
      }
      filtered
    },
    "afro" = df %>% 
      filter(SEXO == "2") %>%
      inner_join(data_main()$soc %>% 
                  filter(P1_15 %in% c("1", "2")) %>% 
                  select(ID_PER),
                by = "ID_PER"))
  
  result %>% filter(NOM_ENT == "Campeche")
})


  
 # Employment Status Plot
  # Update the plots to handle empty data properly
output$status_plot <- renderPlot({
  req(filtered_data_sec8())
  df <- filtered_data_sec8()
  
  if(nrow(df) == 0) {
    plot.new()
    text(0.5, 0.5, "No hay datos disponibles para este filtro", cex = 1.2)
    return()
  }
  
  status_df <- data.frame(
    status = c("Trabajaban", "No Trabajaban", "Sin Respuesta"),
    count = c(
      sum(!is.na(df$P2_10) & df$P2_10 != "97", na.rm = TRUE),
      sum(df$P2_10 == "97", na.rm = TRUE),
      sum(is.na(df$P2_10))
    )
  )
  status_df$percentage <- status_df$count / sum(status_df$count)
  
  ggplot(status_df, aes(x = status, y = percentage, fill = status)) +
    geom_col() +
    geom_text(aes(label = scales::percent(percentage, accuracy = 0.1)),
              position = position_stack(vjust = 1.1)) +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_brewer(palette = "Set2") +
    labs(title = "Estado Laboral Previo a la Detención",
         subtitle = case_when(
           input$work_filter == "all" ~ "Población Total",
           input$work_filter == "women" ~ "Mujeres",
           input$work_filter == "indigenous" ~ "Mujeres Lengua Indígena",
           input$work_filter == "afro" ~ "Mujeres Autoadscripción Indígena/Afro"
         ),
         x = "",
         y = "Porcentaje") +
    theme_minimal() +
    theme(
      legend.position = "none",
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 12),
      axis.text = element_text(size = 12)
    )
})
  
  # Occupations Plot
output$occupations_plot <- renderPlot({
  req(filtered_data_sec8())
  df <- filtered_data_sec8()
  
  if(nrow(df) == 0) {
    plot.new()
    text(0.5, 0.5, "No hay datos disponibles para este filtro", cex = 1.2)
    return()
  }
    
    # Define categorization function
    categorize_occupation <- function(occupation) {
      occupation <- tolower(as.character(occupation))
      
      if (grepl("comercio|comerciante|tienda", occupation)) {
        return("Comercio")
      } else if (grepl("campo|agricultor|cosecha|agricola", occupation)) {
        return("Agricultura")
      } else if (grepl("construccion|albañil|mantenimiento", occupation)) {
        return("Construcción")
      } else if (grepl("empleado|trabajador|jefe", occupation)) {
        return("Servicios")
      } else if (grepl("mecánico|carpintero|pintor", occupation)) {
        return("Oficios")
      } else if (grepl("no trabaja|no responde", occupation)) {
        return("Sin Ocupación")
      } else {
        return("Otros")
      }
    }
  
    # Apply categorization and create plot data
    df$Category <- sapply(df$P2_10, categorize_occupation)
    
    occupation_data <- df %>%
      count(Category) %>%
      mutate(Percentage = n / sum(n) * 100) %>%
      arrange(desc(Percentage))
    
    ggplot(occupation_data, aes(x = reorder(Category, Percentage), y = Percentage)) +
      geom_bar(stat = "identity", fill = "#8E44AD", width = 0.7) +
      geom_text(aes(label = sprintf("%.1f%%", Percentage)),
                hjust = -0.2) +
      coord_flip() +
      labs(title = "Distribución de Ocupaciones",
           subtitle = paste("Filtro:", switch(input$work_filter,
                                           "all" = "Población Total",
                                           "women" = "Mujeres",
                                           "indigenous" = "Mujeres Lengua Indígena",
                                           "afro" = "Mujeres Autoadscripción Indígena/Afro")),
           x = "",
           y = "Porcentaje") +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12)
      )
  })

# Income Sources Plot
output$income_plot <- renderPlot({
  req(filtered_data_sec8())
  df <- filtered_data_sec8()
  
  income_sources <- df %>%
    filter(!is.na(P2_13), !P2_13 %in% c("98", "99")) %>%
    count(P2_13) %>%
    mutate(
      percentage = n / sum(n) * 100,
      source = case_when(
        P2_13 == "01" ~ "Apoyo familiar/amigos",
        P2_13 == "02" ~ "Venta de productos",
        P2_13 == "03" ~ "Servicios",
        P2_13 == "04" ~ "Trabajo agrícola",
        P2_13 == "05" ~ "Programa gubernamental",
        P2_13 == "06" ~ "Actividades informales",
        P2_13 == "07" ~ "Ahorros",
        P2_13 == "08" ~ "Otras fuentes"
      )
    ) %>%
    arrange(desc(percentage))
  
  ggplot(income_sources, aes(x = reorder(source, percentage), y = percentage)) +
    geom_bar(stat = "identity", fill = "#2E86C1", width = 0.7) +
    geom_text(aes(label = sprintf("%.1f%%", percentage)),
              hjust = -0.2) +
    coord_flip() +
    labs(title = "Fuentes de Ingreso",
         subtitle = paste("Filtro:", input$work_filter),
         x = "",
         y = "Porcentaje") +
    theme_minimal()
})
  
  # Section 11: Education Access ----
  # Section 11: Acceso a Educación
filtered_data_sec11 <- reactive({
  req(data_main())
  df <- data_main()$soc
  
  # Add data validation and debugging
  validate(
    need(df, "No se pueden cargar los datos de educación"),
    need(nrow(df) > 0, "No hay datos disponibles")
  )
  
  # Print debug information
  message("Total records before filtering: ", nrow(df))
  message("Women records: ", sum(df$SEXO == "2", na.rm = TRUE))
  message("Indigenous women records: ", sum(df$SEXO == "2" & df$P1_12 == "1", na.rm = TRUE))
  
  result <- switch(input$edu_population_filter,
    "Todos" = df,
    "Mujeres" = df %>% filter(SEXO == "2"),
    "Mujeres Lengua Indígena" = {
      filtered <- df %>% 
        filter(SEXO == "2") %>%
        filter(!is.na(P1_12), P1_12 == "1")
      message("Filtered indigenous women records: ", nrow(filtered))
      validate(
        need(nrow(filtered) > 0, "No hay datos disponibles para mujeres con lengua indígena")
      )
      filtered
    },
    "Mujeres Autoadscripción Indígena/Afro" = df %>% 
      filter(SEXO == "2", !is.na(P1_15), P1_15 %in% c("1", "2"))
  ) %>%
    filter(NOM_ENT == "Campeche")
  
  # Final validation
  validate(
    need(nrow(result) > 0, "No hay datos disponibles para los filtros seleccionados")
  )
  
  result
})
  
  # Education Level Plot
  # Update the education plot rendering
output$education_level_plot <- renderPlot({
  req(filtered_data_sec11())
  
  tryCatch({
    df <- filtered_data_sec11()
    
    if(nrow(df) == 0) {
      plot.new()
      text(0.5, 0.5, "No hay datos disponibles para este filtro", cex = 1.2)
      return()
    }
    
    education_levels <- c(
      "0" = "Sin educación",
      "1" = "Preescolar",
      "2" = "Primaria", 
      "3" = "Secundaria",
      "4" = "Carrera técnica (secundaria)",
      "5" = "Normal básica",
      "6" = "Preparatoria",
      "7" = "Carrera técnica (preparatoria)", 
      "8" = "Licenciatura",
      "9" = "Posgrado"
    )
    
    plot_data <- df %>%
      count(P1_18_N) %>%
      mutate(
        level = case_when(
          as.character(P1_18_N) %in% names(education_levels) ~ 
            education_levels[as.character(P1_18_N)],
          TRUE ~ "No especificado"
        ),
        percentage = n/sum(n) * 100
      ) %>%
      arrange(desc(percentage))
    
    ggplot(plot_data, aes(x = reorder(level, percentage), y = percentage)) +
      geom_bar(stat = "identity", fill = "#2E86C1", width = 0.7) +
      geom_text(aes(label = sprintf("%.1f%%", percentage)),
                hjust = -0.2) +
      coord_flip() +
      labs(
        title = "Distribución por Nivel Educativo",
        subtitle = paste("Filtro:", input$edu_population_filter),
        x = "",
        y = "Porcentaje"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12)
      )
  }, error = function(e) {
    message("Error in plot rendering: ", e$message)
    plot.new()
    text(0.5, 0.5, "Error al generar la visualización", cex = 1.2)
  })
})

# Add UI feedback for data status
output$data_status <- renderUI({
  if (is.null(filtered_data_sec11()) || nrow(filtered_data_sec11()) == 0) {
    div(
      class = "alert alert-warning",
      "No hay datos disponibles para los filtros seleccionados"
    )
  }
})
  
  # Prison Education Plot
output$prison_education_plot <- renderPlot({
  req(filtered_data_sec11())
  df <- filtered_data_sec11()
  
  plot_data <- df %>%
    count(P1_19) %>%
    mutate(
      status = case_when(
        P1_19 == "1" ~ "Estudiando",
        P1_19 == "2" ~ "No estudiando",
        TRUE ~ "Sin información"
      ),
      percentage = n/sum(n) * 100
    )
  
  ggplot(plot_data, aes(x = status, y = percentage, fill = status)) +
    geom_bar(stat = "identity", width = 0.7) +
    geom_text(aes(label = sprintf("%.1f%%", percentage)),
              position = position_stack(vjust = 0.5),
              size = 5) +
    scale_fill_manual(values = c("#2E86C1", "#E74C3C", "#95A5A6")) +
    labs(
      title = "Participación en Programas Educativos",
      subtitle = paste("Filtro:", input$edu_population_filter),
      x = "",
      y = "Porcentaje"
    ) +
    theme_minimal() +
    theme(legend.position = "none")
})

# Dropout Reasons Plot
output$dropout_reasons_plot <- renderPlot({
  req(filtered_data_sec11())
  df <- filtered_data_sec11()
  
  reasons <- c(
    "01" = "No quise/No me interesa",
    "02" = "Dificultad académica",
    "03" = "Otras actividades",
    "04" = "Actividades ilegales",
    "05" = "Falta de dinero",
    "06" = "Expulsión",
    "07" = "Trabajo",
    "08" = "Falta de documentos",
    "09" = "Matrimonio/Embarazo",
    "10" = "Detención",
    "11" = "Salida de cárcel",
    "12" = "Labores del hogar",
    "13" = "Salud",
    "14" = "Adicciones"
  )
  
  plot_data <- df %>%
    count(P1_21) %>%
    mutate(
      reason = reasons[P1_21],
      percentage = n/sum(n) * 100
    ) %>%
    filter(!is.na(reason)) %>%
    arrange(desc(percentage))
  
  ggplot(plot_data, aes(x = reorder(reason, percentage), y = percentage)) +
    geom_bar(stat = "identity", fill = "#2E86C1", width = 0.7) +
    geom_text(aes(label = sprintf("%.1f%%", percentage)),
              hjust = -0.2) +
    coord_flip() +
    labs(
      title = "Razones para Abandonar los Estudios",
      subtitle = paste("Filtro:", input$edu_population_filter),
      x = "",
      y = "Porcentaje"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 12)
    )
})
  
  # Enhanced Data Visualizations ----
  
  # Geographical Distribution Map
  output$geographical_map <- renderLeaflet({
    req(filtered_data_sec1())
    
    # Calculate statistics for choropleth
    state_stats <- filtered_data_sec1() %>%
      group_by(NOM_ENT) %>%
      summarise(
        total_count = n(),
        with_children = sum(P9_8_1 == "1", na.rm = TRUE),
        pct_with_children = with_children / total_count * 100
      )
    
    # Create color palette
    pal <- colorNumeric(
      palette = "YlOrRd",
      domain = state_stats$pct_with_children
    )
    
    # Create map
    leaflet(state_stats) %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      addCircleMarkers(
        lng = ~longitude,
        lat = ~latitude,
        radius = ~sqrt(total_count)/2,
        color = ~pal(pct_with_children),
        popup = ~paste(
          "<strong>", NOM_ENT, "</strong><br/>",
          "Total: ", total_count, "<br/>",
          "Con hijos: ", with_children, "<br/>",
          "Porcentaje: ", round(pct_with_children, 1), "%"
        )
      ) %>%
      addLegend(
        position = "bottomright",
        pal = pal,
        values = ~pct_with_children,
        title = "% con hijos",
        opacity = 0.7
      )
  })
  
  # Temporal Analysis Plot
  output$temporal_analysis <- renderPlot({
    req(filtered_data_sec8())
    
    temporal_data <- filtered_data_sec8() %>%
      mutate(year = year(as.Date(fecha_ingreso))) %>%
      group_by(year) %>%
      summarise(
        working = sum(P2_10 != "97", na.rm = TRUE),
        not_working = sum(P2_10 == "97", na.rm = TRUE)
      ) %>%
      pivot_longer(cols = c(working, not_working),
                  names_to = "status",
                  values_to = "count")
    
    ggplot(temporal_data, aes(x = year, y = count, fill = status)) +
      geom_area(alpha = 0.6) +
      scale_fill_brewer(palette = "Set2") +
      labs(
        title = "Evolución Temporal del Estado Laboral",
        x = "Año",
        y = "Cantidad de Personas",
        fill = "Estado"
      ) +
      theme_minimal()
  })
  
  # Educational Progress Visualization
  output$education_progress <- renderPlot({
    req(filtered_data_sec11())
    
    progress_data <- filtered_data_sec11() %>%
      group_by(P1_19) %>%
      summarise(
        initial_level = mean(as.numeric(P1_18_N), na.rm = TRUE),
        current_level = mean(as.numeric(P1_19), na.rm = TRUE)
      ) %>%
      pivot_longer(cols = c(initial_level, current_level),
                  names_to = "stage",
                  values_to = "level")
    
    ggplot(progress_data, aes(x = stage, y = level, group = P1_19, color = factor(P1_19))) +
      geom_line(size = 1) +
      geom_point(size = 3) +
      scale_color_brewer(palette = "Set1") +
      labs(
        title = "Progreso Educativo en el Sistema Penitenciario",
        x = "Etapa",
        y = "Nivel Educativo Promedio",
        color = "Situación Actual"
      ) +
      theme_minimal()
  })
  
  # Add to the server section:

# Housing Expectations Data Filter
filtered_data_sec13 <- reactive({
  req(data_main())
  df <- data_main()$main

  validate(
    need(!is.null(df) && nrow(df) > 0, "No se pueden cargar los datos")
  )

  result <- tryCatch({
    switch(input$housing_filter,
           "all" = df,
           "women" = df %>% filter(SEXO == "2"),
           "indigenous" = df %>%
             filter(SEXO == "2", !is.na(P1_12), P1_12 == "1"),
           "afro" = df %>%
             filter(SEXO == "2", !is.na(P1_15), P1_15 %in% c("1", "2"))
    )
  }, error = function(e) {
    NULL
  })

  if (is.null(result)) {
    return(data.frame())  # Return empty data frame on error
  }

  result <- result %>% filter(NOM_ENT == "Campeche")

  validate(
    need(nrow(result) > 0, "No hay datos disponibles para los filtros seleccionados")
  )

  return(result)
})

# Housing Availability Plot
# Update the plots to include error handling:
output$housing_availability_plot <- renderPlot({
  tryCatch({
    req(filtered_data_sec13())
    df <- filtered_data_sec13()
    validate(
      need(nrow(df) > 0, "No hay datos disponibles para este filtro.")
    )

    plot_data <- df %>%
      count(P10_2) %>%
      mutate(
        status = case_when(
          P10_2 == "1" ~ "Sí tiene donde vivir",
          P10_2 == "2" ~ "No tiene donde vivir",
          TRUE ~ "Sin información"
        ),
        percentage = n / sum(n) * 100
      )

    ggplot(plot_data, aes(x = status, y = percentage, fill = status)) +
      geom_bar(stat = "identity", width = 0.7) +
      geom_text(aes(label = sprintf("%.1f%%", percentage)),
                position = position_stack(vjust = 0.5)) +
      scale_fill_brewer(palette = "Set2") +
      labs(
        title = "Disponibilidad de Vivienda al Salir",
        x = "",
        y = "Porcentaje"
      ) +
      theme_minimal()
  }, error = function(e) {
    plot.new()
    text(0.5, 0.5, "Error al generar la visualización", cex = 1.2)
  })
})

# Housing Reasons Plot
# Housing Reasons Plot
output$housing_reasons_plot <- renderPlot({
  req(filtered_data_sec13())
  df <- filtered_data_sec13()
  
  # Debugging steps
  print("Unique values in P10_4:")
  print(unique(df$P10_4))
  print("Class of P10_4:")
  print(class(df$P10_4))
  
  reasons <- c(
    "1" = "Rechazo familiar",
    "2" = "Mudanza familiar",
    "3" = "Falta de recursos",
    "4" = "Pérdida de contacto",
    "5" = "No quiere afectar familia"
  )
  
  plot_data <- df %>%
    # Convert P10_4 to character to ensure consistent handling
    mutate(P10_4 = as.character(P10_4)) %>%
    # Exclude specific values, handling potential type issues
    filter(!P10_4 %in% c("8", "9", NA)) %>%
    count(P10_4) %>%
    mutate(
      # Use careful mapping with error handling
      reason = ifelse(P10_4 %in% names(reasons), 
                      reasons[P10_4], 
                      paste("Razón desconocida:", P10_4)),
      percentage = n/sum(n) * 100
    ) %>%
    arrange(desc(percentage))
  
  ggplot(plot_data, aes(x = reorder(reason, percentage), y = percentage)) +
    geom_bar(stat = "identity", fill = "#2E86C1", width = 0.7) +
    geom_text(aes(label = sprintf("%.1f%%", percentage)),
              hjust = -0.2) +
    coord_flip() +
    labs(
      title = "Razones por No Tener Vivienda al Salir",
      subtitle = paste("Filtro:", input$housing_filter),
      x = "",
      y = "Porcentaje"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 12)
    )
})

# Previous Housing Plot
# Previous Housing Plot
output$previous_housing_plot <- renderPlot({
  req(filtered_data_sec13())
  df <- filtered_data_sec13()

  plot_data <- df %>%
    count(P10_3) %>%
    mutate(
      status = case_when(
        P10_3 == "1" ~ "Misma vivienda anterior",
        P10_3 == "2" ~ "Vivienda diferente",
        TRUE ~ "Sin información"
      ),
      percentage = n/sum(n) * 100
    )

  ggplot(plot_data, aes(x = status, y = percentage, fill = status)) +
    geom_bar(stat = "identity", width = 0.7) +
    geom_text(aes(label = sprintf("%.1f%%", percentage)),
              position = position_stack(vjust = 0.5)) +
    scale_fill_brewer(palette = "Set2") +
    labs(
      title = "Comparación de Vivienda Anterior",
      x = "",
      y = "Porcentaje"
    ) +
    theme_minimal()
  })


# Tables
output$housing_availability_table <- renderDT({
  req(filtered_data_sec13())
  df <- filtered_data_sec13()
  
  df %>%
    count(P10_2) %>%
    mutate(
      status = case_when(
        P10_2 == "1" ~ "Sí tiene donde vivir",
        P10_2 == "2" ~ "No tiene donde vivir",
        TRUE ~ "Sin información"
      ),
      percentage = sprintf("%.1f%%", n/sum(n) * 100)
    ) %>%
    select(Status = status, Count = n, Percentage = percentage) %>%
    datatable(options = list(dom = 't'))
})

output$housing_reasons_plot <- renderPlot({
  # Ensure data is available
  req(filtered_data_sec13())
  
  # Create the dataframe
  df <- filtered_data_sec13()
  
  # Debugging: Comprehensive column and data checks
  print("Column names in the dataframe:")
  print(names(df))
  
  print("Is P10_4 column present?")
  print("P10_4" %in% names(df))
  
  print("Data types of columns:")
  print(str(df))
  
  # If column exists, proceed with plotting
  if("P10_4" %in% names(df)) {
    # Print unique values with additional checks
    print("Unique values in P10_4:")
    print(unique(df$P10_4))
    print("Class of P10_4:")
    print(class(df$P10_4))
  }
  
  # Define reasons mapping
  reasons <- c(
    "1" = "Rechazo familiar", 
    "2" = "Mudanza familiar", 
    "3" = "Falta de recursos", 
    "4" = "Pérdida de contacto", 
    "5" = "No quiere afectar familia"
  )
  
  tryCatch({
    plot_data <- df %>% 
      # Modify filtering to handle unexpected values
      filter(!P10_4 %in% c("8", "9", "g")) %>%
      # If the column is not numeric, convert carefully
      mutate(P10_4 = as.character(P10_4)) %>%
      count(P10_4) %>% 
      mutate(
        reason = ifelse(P10_4 %in% names(reasons), 
                        reasons[P10_4], 
                        paste("Unknown Reason:", P10_4)),
        percentage = n/sum(n) * 100
      ) %>% 
      arrange(desc(percentage))
    
    # Create the plot
    ggplot(plot_data, aes(x = reorder(reason, percentage), y = percentage)) +
      geom_bar(stat = "identity", fill = "#2E86C1", width = 0.7) +
      geom_text(aes(label = sprintf("%.1f%%", percentage)), hjust = -0.2) +
      coord_flip() +
      labs(
        title = "Razones por No Tener Vivienda al Salir", 
        subtitle = paste("Filtro:", input$housing_filter), 
        x = "", 
        y = "Porcentaje"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12)
      )
  }, error = function(e) {
    # Print error message for debugging
    print(paste("Error:", e$message))
    
    # Return a null plot or error plot
    ggplot() + 
      annotate("text", x = 1, y = 1, label = paste("Error:", e$message)) +
      theme_minimal()
  })
})

output$previous_housing_table <- renderDT({
  req(filtered_data_sec13())
  df <- filtered_data_sec13()
  
  df %>%
    count(P10_3) %>%
    mutate(
      status = case_when(
        P10_3 == "1" ~ "Misma vivienda anterior",
        P10_3 == "2" ~ "Vivienda diferente",
        TRUE ~ "Sin información"
      ),
      percentage = sprintf("%.1f%%", n/sum(n) * 100)
    ) %>%
    select(Status = status, Count = n, Percentage = percentage) %>%
    datatable(options = list(dom = 't'))
})

# Add a UI status indicator
output$data_status_sec13 <- renderUI({
  if (is.null(filtered_data_sec13()) || nrow(filtered_data_sec13()) == 0) {
    div(
      class = "alert alert-warning",
      "No hay datos disponibles para los filtros seleccionados"
    )
  }
})
  
}



# Run the app
shinyApp(ui = ui, server = server)
```
---
# Seccion 1

```{r librerias}
library(shiny)
library(tidyverse)
library(DT)
library(scales)
```

# Section 1 
```{r release}
library(shiny)
library(tidyverse)
library(DT)
library(scales)

# Helper function to format ID_PER consistently
format_id_per <- function(id) {
  as.character(sprintf("%.4f", as.numeric(id)))
}

# Helper function to create empty data message
create_empty_message <- function(filter_type) {
  div(
    style = "text-align: center; color: #666; padding: 20px;",
    h4("No hay datos disponibles"),
    p(paste("No se encontraron registros para", filter_type, "en Campeche")),
    p("Por favor seleccione otro filtro")
  )
}

# Custom theme for consistent plot styling
custom_theme <- function() {
  theme_minimal() +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5, margin = margin(b = 20)),
      plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 10)),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 10),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.title = element_text(size = 10, face = "bold"),
      legend.text = element_text(size = 9),
      legend.position = "bottom",
      panel.grid.major = element_line(color = "gray90"),
      panel.grid.minor = element_blank(),
      strip.text = element_text(size = 11, face = "bold")
    )
}

# Enhanced table formatting function
format_dt_table <- function(data) {
  datatable(
    data,
    options = list(
      dom = 't',
      ordering = FALSE,
      pageLength = -1,
      headerCallback = JS(
        "function(thead, data, start, end, display){",
        "  $(thead).css('background-color', '#f0f0f0');",
        "  $(thead).css('font-weight', 'bold');",
        "}"
      )
    ),
    rownames = FALSE,
    class = 'cell-border stripe hover'
  ) %>%
    formatStyle(
      columns = names(data),
      backgroundColor = styleEqual(c("0%", "100%"), c('#f8f9fa', '#e9ecef')),
      fontWeight = 'bold'
    )
}

# UI Components
ui <- fluidPage(
  titlePanel("Análisis de Antecedentes Familiares - ENPOL 2021"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("population_filter", "Filtrar por:",
                 choices = c("Todos",
                           "Mujeres",
                           "Mujeres Lengua Indígena",
                           "Mujeres Autoadscripción Indígena/Afro")),
      selectInput("state_filter", "Estado:",
                 choices = "Campeche")
    ),
    mainPanel(
      uiOutput("data_message"),
      
      tabsetPanel(
        tabPanel("Convivencia",
                plotOutput("living_situation_plot"),
                h4("Datos:"),
                DTOutput("living_situation_table")),
        tabPanel("Violencia/Precariedad",
                plotOutput("violence_plot"),
                h4("Datos:"),
                DTOutput("violence_table")),
        tabPanel("Percepción de Seguridad",
                plotOutput("security_plot"),
                h4("Datos:"),
                DTOutput("security_table"))
      )
    )
  )
)

server <- function(input, output, session) {
  # Load and merge data
  data <- reactive({
    main_data <- read.csv("../data/ENPOL2021_8_9_10_11.csv", encoding = "latin1") %>%
      mutate(ID_PER = format_id_per(ID_PER))
    
    soc_data <- read.csv("../data/ENPOL2021_SOC.csv", encoding = "latin1") %>%
      mutate(ID_PER = format_id_per(ID_PER))
    
    merged_data <- main_data %>%
      left_join(soc_data %>% select(ID_PER, P1_12, P1_15), 
                by = "ID_PER")
    
    return(merged_data)
  })
  
  # Filtered data
  filtered_data <- reactive({
    req(data())
    df <- data()
    
    result <- switch(input$population_filter,
                    "Todos" = df,
                    "Mujeres" = df %>% filter(SEXO == "2"),
                    "Mujeres Lengua Indígena" = df %>% 
                      filter(SEXO == "2", P1_12 == "1"),
                    "Mujeres Autoadscripción Indígena/Afro" = df %>% 
                      filter(SEXO == "2", P1_15 %in% c("1", "2")))
    
    result <- result %>% filter(NOM_ENT == "Campeche")
    
    print(paste("Filter:", input$population_filter))
    print(paste("Total records before Campeche filter:", nrow(df)))
    print(paste("Records in Campeche:", nrow(result)))
    
    return(result)
  })
  
  # Data availability message
  output$data_message <- renderUI({
    req(filtered_data())
    df <- filtered_data()
    
    if(nrow(df) == 0) {
      create_empty_message(input$population_filter)
    }
  })
  
  # Living Situation Plot
  output$living_situation_plot <- renderPlot({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    plot_data <- df %>%
      summarise(
        "Vivía con mamá" = mean(P9_8_1 == "1", na.rm = TRUE),
        "Vivía con papá" = mean(P9_8_2 == "1", na.rm = TRUE)
      ) %>%
      pivot_longer(everything(), names_to = "Situación", values_to = "Porcentaje")
    
    ggplot(plot_data, aes(x = Situación, y = Porcentaje, fill = Situación)) +
      geom_bar(stat = "identity", width = 0.7) +
      geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)), 
                position = position_stack(vjust = 0.5),
                size = 4, fontface = "bold") +
      scale_y_continuous(labels = scales::percent, limits = c(0, 1),
                        breaks = seq(0, 1, 0.2)) +
      scale_fill_brewer(palette = "Set2") +
      labs(title = "Convivencia Familiar en la Infancia",
           subtitle = paste("Filtro:", input$population_filter),
           y = "Porcentaje",
           x = "") +
      custom_theme()
  })
  
  # Violence Plot
  output$violence_plot <- renderPlot({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    plot_data <- df %>%
      summarise(
        "Presenció violencia" = mean(P9_10_3 == "1", na.rm = TRUE),
        "Perteneció a pandilla" = mean(P9_10_4 == "1", na.rm = TRUE)
      ) %>%
      pivot_longer(everything(), names_to = "Situación", values_to = "Porcentaje")
    
    ggplot(plot_data, aes(x = Situación, y = Porcentaje, fill = Situación)) +
      geom_bar(stat = "identity", width = 0.7) +
      geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)),
                position = position_stack(vjust = 0.5),
                size = 4, fontface = "bold") +
      scale_y_continuous(labels = scales::percent, limits = c(0, 1),
                        breaks = seq(0, 1, 0.2)) +
      scale_fill_brewer(palette = "Set3") +
      labs(title = "Experiencias de Violencia",
           subtitle = paste("Filtro:", input$population_filter),
           y = "Porcentaje",
           x = "") +
      custom_theme()
  })
  
  # Security Plot
  output$security_plot <- renderPlot({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    plot_data <- df %>%
      summarise(
        "Se sentía seguro" = mean(P9_10_1 == "1", na.rm = TRUE),
        "Vecinos se preocupaban" = mean(P9_10_2 == "1", na.rm = TRUE)
      ) %>%
      pivot_longer(everything(), names_to = "Situación", values_to = "Porcentaje")
    
    ggplot(plot_data, aes(x = Situación, y = Porcentaje, fill = Situación)) +
      geom_bar(stat = "identity", width = 0.7) +
      geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)),
                position = position_stack(vjust = 0.5),
                size = 4, fontface = "bold") +
      scale_y_continuous(labels = scales::percent, limits = c(0, 1),
                        breaks = seq(0, 1, 0.2)) +
      scale_fill_brewer(palette = "Set1") +
      labs(title = "Percepción de Seguridad",
           subtitle = paste("Filtro:", input$population_filter),
           y = "Porcentaje",
           x = "") +
      custom_theme()
  })
  
  # Tables with enhanced formatting
  output$living_situation_table <- renderDT({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    format_dt_table(df %>%
      summarise(
        "Vivía con mamá" = scales::percent(mean(P9_8_1 == "1", na.rm = TRUE), accuracy = 0.1),
        "Vivía con papá" = scales::percent(mean(P9_8_2 == "1", na.rm = TRUE), accuracy = 0.1)
      ))
  })
  
  output$violence_table <- renderDT({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    format_dt_table(df %>%
      summarise(
        "Presenció violencia" = scales::percent(mean(P9_10_3 == "1", na.rm = TRUE), accuracy = 0.1),
        "Perteneció a pandilla" = scales::percent(mean(P9_10_4 == "1", na.rm = TRUE), accuracy = 0.1)
      ))
  })
  
  output$security_table <- renderDT({
    req(filtered_data())
    df <- filtered_data()
    req(nrow(df) > 0)
    
    format_dt_table(df %>%
      summarise(
        "Se sentía seguro" = scales::percent(mean(P9_10_1 == "1", na.rm = TRUE), accuracy = 0.1),
        "Vecinos se preocupaban" = scales::percent(mean(P9_10_2 == "1", na.rm = TRUE), accuracy = 0.1)
      ))
  })
}

shinyApp(ui = ui, server = server)
```

# Section 1 
```{R}
library(shiny)
library(leaflet)
library(tidyverse)
library(DT)
library(scales)
library(leaflet.providers)

# UI Components
ui <- fluidPage(
  theme = bslib::bs_theme(version = 4),
  titlePanel("Maternidad y Salud en el Sistema Penitenciario Mexicano"),
  
  tabsetPanel(
    # First Page - Map and Graph
    tabPanel("Visualización Geográfica",
      fluidRow(
        column(12,
          p("Este análisis muestra la distribución y condiciones de las mujeres que viven con sus hijos en prisión 
            y aquellas que han sido diagnosticadas con enfermedades durante su reclusión.", 
            style = "font-size: 16px; margin: 20px 0;")
        )
      ),
      fluidRow(
        # Map and graph layout
        column(6,
          leafletOutput("map", height = 500)
        ),
        column(6,
          plotOutput("barPlot", height = 500)
        )
      ),
      fluidRow(
        column(12,
          p("* Haga clic en un estado del mapa para ver detalles específicos",
            style = "font-style: italic; color: #666; margin-top: 10px;")
        )
      )
    ),
    
    # Second Page - Interactive Table
    tabPanel("Datos Detallados",
      fluidRow(
        column(12,
          p("Explore los datos detallados sobre las condiciones de salud y maternidad en el sistema penitenciario.", 
            style = "font-size: 16px; margin: 20px 0;")
        )
      ),
      fluidRow(
        column(12,
          DTOutput("dataTable")
        )
      )
    )
  )
)

server <- function(input, output, session) {
  # Coordinates data
  coords <- data.frame(
    NOM_ENT = c("Aguascalientes", "Baja California", "Baja California Sur", "Campeche", "Chiapas",
                "Chihuahua", "Coahuila", "Colima", "Durango", "Guanajuato", "Guerrero", "Hidalgo",
                "Jalisco", "Estado de México", "Michoacán", "Morelos", "Nayarit", "Nuevo León",
                "Oaxaca", "Puebla", "Querétaro", "Quintana Roo", "San Luis Potosí", "Sinaloa",
                "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", "Veracruz", "Yucatán", "Zacatecas",
                "Ciudad de México"),
    lat = c(21.885, 32.526, 24.144, 19.832, 16.757, 28.635, 27.058, 19.123, 24.027, 20.917, 17.439, 20.091,
            20.659, 19.359, 19.566, 18.926, 21.751, 25.686, 17.071, 19.041, 20.588, 19.666, 22.158, 24.808,
            29.072, 18.003, 23.741, 19.313, 19.173, 20.709, 22.770, 19.432),
    lng = c(-102.291, -116.991, -110.299, -90.538, -93.113, -106.089, -101.706, -104.825, -104.653, -101.256,
            -99.543, -98.762, -103.348, -99.650, -101.189, -99.070, -104.895, -100.316, -96.721, -98.206,
            -100.393, -88.327, -100.987, -107.394, -110.974, -92.919, -98.998, -98.239, -96.142, -89.070,
            -102.583, -99.133)
  )

  # Reactive data
  data <- reactive({
    # Load and merge motherhood data
    data_mothers <- read.csv("../data/ENPOL2021_6.csv", encoding = "latin1") %>%
      filter(SEXO == 2) %>%  # Filter for women
      group_by(NOM_ENT) %>%
      summarise(total_mujeres = n(),
                mujeres_con_hijos = sum(P6_1 == 1, na.rm = TRUE))
    
    # Load and merge health data
    data_health <- read.csv("../data/ENPOL2021_SOC.csv", encoding = "latin1") %>%
      filter(SEXO == 2) %>%  # Filter for women
      group_by(NOM_ENT) %>%
      summarise(mujeres_enfermas = sum(P1_24_1 == 1, na.rm = TRUE))
    
    # Combine data
    data_combined <- data_mothers %>%
      left_join(data_health, by = "NOM_ENT") %>%
      left_join(coords, by = "NOM_ENT")
    
    return(data_combined)
  })
  
  # Selected state
  selected_state <- reactiveVal(NULL)
  
  # Map output
  output$map <- renderLeaflet({
  req(data())
  
  # Create a custom color palette with better scaled purples
  pal <- colorNumeric(
    palette = c("#F5F0F7", "#9B59B6", "#8E44AD", "#6C3483"), # Light to dark purple
    domain = data()$mujeres_con_hijos
  )
  
  # Adjust the radius scaling factor
  radius_scale <- function(x) {
    sqrt(x) * 1.5  # Reduced multiplier for smaller bubbles
  }
  
  leaflet(data()) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%  # Light background
    addCircleMarkers(
      lng = ~lng,
      lat = ~lat,
      radius = ~radius_scale(mujeres_con_hijos),  # Adjusted radius scaling
      color = ~pal(mujeres_con_hijos),
      fillOpacity = 0.7,
      stroke = TRUE,
      weight = 1,
      popup = ~sprintf(
        "<div style='padding: 10px; border-radius: 5px;'>
         <strong style='color: #4A235A;'>%s</strong><br/>
         <hr style='margin: 5px 0;'/>
         <b>Mujeres con hijos:</b> %d<br/>
         <b>Mujeres diagnosticadas:</b> %d<br/>
         <b>Total de mujeres:</b> %d<br/>
         <hr style='margin: 5px 0;'/>
         <b>Porcentaje con hijos:</b> %.1f%%<br/>
         <b>Porcentaje diagnosticadas:</b> %.1f%%</div>",
        NOM_ENT,
        mujeres_con_hijos,
        mujeres_enfermas,
        total_mujeres,
        mujeres_con_hijos/total_mujeres * 100,
        mujeres_enfermas/total_mujeres * 100
      ),
      layerId = ~NOM_ENT,
      label = ~NOM_ENT
    ) %>%
    addLegend(
      position = "bottomright",
      pal = pal,
      values = ~mujeres_con_hijos,
      title = "Mujeres con hijos",
      opacity = 0.7,
      labFormat = labelFormat(suffix = " mujeres")
    )
})
  
  # Observe map clicks
  observeEvent(input$map_marker_click, {
    selected_state(input$map_marker_click$id)
  })
  
  # Bar plot output
  output$barPlot <- renderPlot({
  req(data())
  
  plot_data <- data()
  
  if (!is.null(selected_state())) {
    plot_data <- plot_data %>%
      filter(NOM_ENT == selected_state())
  }
  
  ggplot(plot_data, aes(x = reorder(NOM_ENT, -mujeres_con_hijos))) +
    geom_bar(aes(y = mujeres_con_hijos, fill = "Mujeres con hijos"), 
             stat = "identity", alpha = 0.9) +
    geom_bar(aes(y = mujeres_enfermas, fill = "Mujeres diagnosticadas"), 
             stat = "identity", alpha = 0.7) +
    # Add data labels
    geom_text(aes(y = mujeres_con_hijos, 
                  label = mujeres_con_hijos),
              vjust = -0.5, 
              size = 3.5, 
              fontface = "bold") +
    geom_text(aes(y = mujeres_enfermas, 
                  label = mujeres_enfermas),
              vjust = 1.5, 
              size = 3.5, 
              fontface = "bold",
              color = "white") +
    scale_fill_manual(values = c("Mujeres con hijos" = "#8E44AD", 
                                "Mujeres diagnosticadas" = "#C0392B")) +
    labs(
      title = if (!is.null(selected_state())) {
        paste("Detalle de", selected_state())
      } else {
        "Distribución de Mujeres en el Sistema Penitenciario"
      },
      subtitle = if (!is.null(selected_state())) {
        paste("Total de mujeres:", 
              sum(plot_data$total_mujeres, na.rm = TRUE))
      } else {
        "Por Estado y Condición"
      },
      x = "Estado",
      y = "Número de Mujeres",
      fill = "Categoría"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, 
                              size = 16, 
                              face = "bold",
                              margin = margin(b = 10)),
      plot.subtitle = element_text(hjust = 0.5, 
                                 size = 12, 
                                 color = "gray40",
                                 margin = margin(b = 20)),
      axis.text.x = element_text(angle = 45, 
                               hjust = 1, 
                               size = 10),
      axis.text.y = element_text(size = 10),
      axis.title = element_text(size = 12, face = "bold"),
      legend.position = "bottom",
      legend.title = element_text(size = 11),
      legend.text = element_text(size = 10),
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      panel.grid.major.y = element_line(color = "gray90")
    ) +
    scale_y_continuous(
      expand = expansion(mult = c(0, 0.1)),
      labels = scales::comma
    )
  })
  
  # Interactive table output
  output$dataTable <- renderDT({
  req(data())
  
  formatted_data <- data() %>%
    select(
      Estado = NOM_ENT,
      `Total Mujeres` = total_mujeres,
      `Mujeres con Hijos` = mujeres_con_hijos,
      `Mujeres Diagnosticadas` = mujeres_enfermas
    ) %>%
    mutate(
      `% Con Hijos` = (`Mujeres con Hijos` / `Total Mujeres`),
      `% Diagnosticadas` = (`Mujeres Diagnosticadas` / `Total Mujeres`)
    )
  
  datatable(
    formatted_data,
    options = list(
      pageLength = 10,
      order = list(1, 'desc'),
      dom = 'lrtip',
      language = list(
        url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json'
      )
    ),
    rownames = FALSE,
    class = 'cell-border stripe hover',
    filter = 'top'
  ) %>%
    formatRound(c("Total Mujeres", "Mujeres con Hijos", "Mujeres Diagnosticadas"), 0) %>%
    formatPercentage(c("% Con Hijos", "% Diagnosticadas"), 2) %>%
    formatStyle(
      columns = c("% Con Hijos", "% Diagnosticadas"),
      background = styleColorBar(c(0, 1), "#8E44AD40"),
      backgroundSize = '98% 88%',
      backgroundRepeat = 'no-repeat',
      backgroundPosition = 'center'
    )
})
}

shinyApp(ui = ui, server = server)
```
---
# Seccion 8: 

```{R seccion8}
server <- function(input, output, session) {
  # Load data once at startup
  emp_data <- read.csv("../data/ENPOL2021_2_3.csv", encoding = "latin1")
  soc_data <- read.csv("../data/ENPOL2021_SOC.csv", encoding = "latin1")
  
  # Filter data
  filtered_data <- reactive({
    result <- emp_data
    
    if (input$population_filter == "women") {
      result <- result[result$SEXO == "2", ]
    } else if (input$population_filter == "indigenous") {
      indigenous_ids <- soc_data$ID_PER[soc_data$P1_12 == "1"]
      result <- result[result$SEXO == "2" & result$ID_PER %in% indigenous_ids, ]
    } else if (input$population_filter == "afro") {
      afro_ids <- soc_data$ID_PER[soc_data$P1_15 %in% c("1", "2")]
      result <- result[result$SEXO == "2" & result$ID_PER %in% afro_ids, ]
    }
    
    result
  })
  
  # Employment Status Plot (working version remains unchanged)
  output$status_plot <- renderPlot({
    df <- filtered_data()
    
    status_df <- data.frame(
      status = c("Trabajaban", "No Trabajaban", "Sin Respuesta"),
      count = c(
        sum(!is.na(df$P2_10) & df$P2_10 != "97", na.rm = TRUE),
        sum(df$P2_10 == "97", na.rm = TRUE),
        sum(is.na(df$P2_10))
      )
    )
    status_df$percentage <- status_df$count / sum(status_df$count)
    
    ggplot(status_df, aes(x = status, y = percentage, fill = status)) +
      geom_col() +
      geom_text(aes(label = scales::percent(percentage, accuracy = 0.1)),
                position = position_stack(vjust = 1.1)) +
      scale_y_continuous(labels = scales::percent) +
      scale_fill_brewer(palette = "Set2") +
      labs(title = "Estado Laboral Previo a la Detención",
           subtitle = case_when(
             input$population_filter == "all" ~ "Población Total",
             input$population_filter == "women" ~ "Mujeres",
             input$population_filter == "indigenous" ~ "Mujeres Lengua Indígena",
             input$population_filter == "afro" ~ "Mujeres Autoadscripción Indígena/Afro"
           ),
           x = "",
           y = "Porcentaje") +
      theme_minimal() +
      theme(
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.text = element_text(size = 12)
      )
  })
  
  # Define a function to categorize occupations
  categorize_occupation <- function(occupation) {
    occupation <- tolower(occupation)  # Convert to lowercase for easier matching
    
    if (grepl("comercio|comerciante|tienda", occupation)) {
      return("Commerce")
    } else if (grepl("campo|agricultor|cosecha|agricola|piña|limones", occupation)) {
      return("Agriculture")
    } else if (grepl("construccion|albañil|mantenimiento", occupation)) {
      return("Construction")
    } else if (grepl("empleado|trabajador|jefe", occupation)) {
      return("Services")
    } else if (grepl("mecánico|carpintero|pintor", occupation)) {
      return("Skilled Trades")
    } else if (grepl("seguridad|policía|guardia", occupation)) {
      return("Security")
    } else if (grepl("no trabaja|no responde", occupation)) {
      return("Unemployed")
    } else {
      return("Other")
    }
  }
  
  # Occupations Plot
  output$occupations_plot <- renderPlot({
    df <- filtered_data()
    
    # Debugging: Check filtered data structure
    if (nrow(df) == 0 || is.null(df$P2_10)) {
      plot.new()
      text(0.5, 0.5, "No data available for occupations", cex = 1.2)
      return()
    }
    
    # Apply categorization
    df$Category <- sapply(as.character(df$P2_10), categorize_occupation)
    
    # Debugging: Check categories
    if (all(is.na(df$Category))) {
      plot.new()
      text(0.5, 0.5, "No valid categories for occupations", cex = 1.2)
      return()
    }
    
    # Aggregate data
    category_counts <- table(df$Category)
    percentages <- as.numeric(category_counts) / sum(category_counts)
    names(percentages) <- names(category_counts)
    
    # Sort in descending order
    percentages <- sort(percentages, decreasing = TRUE)
    
    # Adjust margins for labels
    par(mar = c(5, 15, 4, 2))
    
    # Create plot
    plot(
      percentages,
      seq_along(percentages),
      type = "n",
      xlab = "Porcentaje del Total",
      ylab = "",
      main = "Distribución de Ocupaciones",
      axes = FALSE,
      xlim = c(0, max(percentages) * 1.3),
      ylim = c(0.5, length(percentages) + 0.5)
    )
    
    # Add axes and labels
    axis(1)
    axis(2, at = seq_along(percentages), labels = names(percentages), las = 1, cex.axis = 0.8)
    
    # Add lollipop chart
    segments(0, seq_along(percentages), percentages, seq_along(percentages), col = "#8E44AD", lwd = 2)
    points(percentages, seq_along(percentages), pch = 16, col = "#8E44AD", cex = 1.5)
    text(percentages + 0.02, seq_along(percentages), 
         labels = sprintf("%.1f%% (%d personas)", percentages * 100, as.numeric(category_counts)), 
         pos = 4, cex = 0.8)
  })

  # Enhanced Income Sources Plot
  # Income Sources Plot with Fixed Y-Axis Labels
  output$income_plot <- renderPlot({
    df <- filtered_data()
    
    # Check if data is available
    if (nrow(df) == 0 || is.null(df$P2_13)) {
      plot.new()
      text(0.5, 0.5, "No data available for income sources", cex = 1.2)
      return()
    }
    
    # Aggregate data correctly and filter out 98, 99 codes
    income_sources <- df %>%
      filter(!is.na(P2_13), 
             !P2_13 %in% c("98", "99")) %>%  # Filter out no sabe/no responde
      count(P2_13) %>%
      arrange(desc(n))
    
    if (nrow(income_sources) == 0) {
      plot.new()
      text(0.5, 0.5, "No data available for income sources", cex = 1.2)
      return()
    }
    
    # Calculate percentages
    total_responses <- sum(income_sources$n)
    income_sources <- income_sources %>%
      mutate(percentage = n / total_responses)
    
    # Define descriptions
    descriptions <- c(
        "01" = "Un familiar o amigo(a) me daba dinero",
        "02" = "Vendía o realizaba algún producto para su venta",
        "03" = "Ofrecía algún servicio a cambio de un pago",
        "04" = "Trabajaba en tierras propias o ayudando",
        "05" = "Recibía apoyo de un programa de gobierno",
        "06" = "Negocios chuecos, al 'bisne', actividades ilegales",
        "07" = "Vivía de mis ahorros",
        "08" = "Otra actividad"
    )
    
    # Create layout with extra space at bottom for legend
    layout(matrix(c(1,2), nrow=2, ncol=1), heights=c(4,1))
    
    # Set up the main plot
    par(mar = c(5, 8, 4, 8))
    
    # Create the base plot
    plot(income_sources$percentage,
         seq_along(income_sources$percentage),
         type = "n",
         xlab = "Porcentaje del Total",
         ylab = "",
         main = "Distribución de Fuentes de Ingreso",
         axes = FALSE,
         xlim = c(0, max(income_sources$percentage) * 1.2),
         ylim = c(0.5, nrow(income_sources) + 0.5))
    
    # Add horizontal lines and points
    segments(0, seq_along(income_sources$percentage), 
             income_sources$percentage, seq_along(income_sources$percentage), 
             col = "#2E86C1", 
             lwd = 2)
    points(income_sources$percentage, seq_along(income_sources$percentage), 
           pch = 16, 
           col = "#2E86C1", 
           cex = 1.5)
    
    # Add x-axis
    axis(1, at = pretty(c(0, max(income_sources$percentage))), 
         labels = paste0(pretty(c(0, max(income_sources$percentage))) * 100, "%"))
    
    # Add y-axis with codes
    axis(2, at = seq_along(income_sources$percentage), 
         labels = sprintf("%02d", as.numeric(income_sources$P2_13)), 
         las = 2,
         cex.axis = 0.8)
    
    # Add count labels on the right
    text(income_sources$percentage, 
         seq_along(income_sources$percentage), 
         sprintf(" %.1f%% (%d personas)", 
                 income_sources$percentage * 100, 
                 income_sources$n),
         pos = 4,
         cex = 0.8)
    
    # Create legend plot
    par(mar = c(0, 2, 0, 2))
    plot.new()
    plot.window(xlim = c(0, 1), ylim = c(0, 1))
    
    # Split descriptions into two columns with more space for text
    n_desc <- length(descriptions)
    mid_point <- ceiling(n_desc/2)
    
    # First column of descriptions (moved more to the left)
    text(0.02, seq(0.8, 0.2, length.out = mid_point), 
         sprintf("%02d - %s", 1:mid_point, descriptions[1:mid_point]),
         cex = 0.8, pos = 4, adj = 0)
    
    # Second column of descriptions (starting closer to middle)
    text(0.52, seq(0.8, 0.2, length.out = n_desc - mid_point), 
         sprintf("%02d - %s", (mid_point+1):n_desc, descriptions[(mid_point+1):n_desc]),
         cex = 0.8, pos = 4, adj = 0)
    
  }, height = 600)
}

shinyApp(ui = ui, server = server)
```

---
# Seccion 11

```{R}
library(shiny)
library(tidyverse)
library(DT)
library(scales)

ui <- fluidPage(
  theme = bslib::bs_theme(version = 4),
  titlePanel("Análisis de Acceso a la Educación - ENPOL 2021"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("population_filter", "Filtrar por:",
                 choices = c("Todos",
                           "Mujeres",
                           "Mujeres Lengua Indígena",
                           "Mujeres Autoadscripción Indígena/Afro")),
      selectInput("state_filter", "Estado:",
                 choices = "Campeche")
    ),
    
    mainPanel(
      tabsetPanel(
        # Educational Level Tab
        tabPanel("Nivel Educativo",
                plotOutput("education_level_plot", height = "600px"),
                DTOutput("education_level_table")),
        
        # Prison Education Tab
        tabPanel("Educación en Prisión",
                plotOutput("prison_education_plot", height = "600px"),
                DTOutput("prison_education_table")),
        
        # Dropout Reasons Tab
        tabPanel("Razones de Abandono",
                plotOutput("dropout_reasons_plot", height = "600px"),
                DTOutput("dropout_reasons_table"))
      )
    )
  )
)

server <- function(input, output, session) {
  # Load and process data
  data <- reactive({
    edu_data <- read.csv("../data/ENPOL2021_SOC.csv", encoding = "latin1")
    
    filtered <- switch(input$population_filter,
      "Todos" = edu_data,
      "Mujeres" = edu_data %>% filter(SEXO == "2"),
      "Mujeres Lengua Indígena" = edu_data %>% 
        filter(SEXO == "2", P1_12 == "1"),
      "Mujeres Autoadscripción Indígena/Afro" = edu_data %>% 
        filter(SEXO == "2", P1_15 %in% c("1", "2"))
    )
    
    filtered %>% filter(NOM_ENT == "Campeche")
  })

  output$education_level_plot <- renderPlot({
    req(data())
    
    # Define education levels mapping
    education_levels <- c(
      "0" = "Sin educación",
      "1" = "Preescolar",
      "2" = "Primaria", 
      "3" = "Secundaria",
      "4" = "Carrera técnica (secundaria)",
      "5" = "Normal básica",
      "6" = "Preparatoria",
      "7" = "Carrera técnica (preparatoria)", 
      "8" = "Licenciatura",
      "9" = "Posgrado",
      "98" = "No sabe",
      "99" = "No responde"
    )
    
    plot_data <- data() %>%
      count(P1_18_N) %>%  # Changed from P1_18 to P1_18_N
      mutate(
        level = case_when(
          as.character(P1_18_N) %in% names(education_levels) ~ education_levels[as.character(P1_18_N)],
          TRUE ~ "No especificado"
        ),
        percentage = n/sum(n) * 100
      ) %>%
      arrange(desc(percentage))
    
    ggplot(plot_data, aes(x = reorder(level, percentage), y = percentage)) +
      geom_bar(stat = "identity", fill = "#2E86C1", width = 0.7) +
      geom_text(aes(label = sprintf("%.1f%%", percentage)),
                hjust = -0.2) +
      scale_y_continuous(limits = c(0, max(plot_data$percentage) * 1.2)) +
      coord_flip() +
      labs(
        title = "Distribución por Nivel Educativo",
        subtitle = paste("Filtro:", input$population_filter),
        x = "",
        y = "Porcentaje"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12)
      )
  })

  # Prison Education Plot
  output$prison_education_plot <- renderPlot({
    req(data())
    
    plot_data <- data() %>%
      count(P1_19) %>%
      mutate(
        status = case_when(
          P1_19 == "1" ~ "Estudiando",
          P1_19 == "2" ~ "No estudiando",
          TRUE ~ "Sin información"
        ),
        percentage = n/sum(n) * 100
      )
    
    ggplot(plot_data, aes(x = status, y = percentage, fill = status)) +
      geom_bar(stat = "identity", width = 0.7) +
      geom_text(aes(label = sprintf("%.1f%%", percentage)),
                position = position_stack(vjust = 0.5),
                size = 5) +
      scale_fill_manual(values = c("#2E86C1", "#E74C3C", "#95A5A6")) +
      labs(
        title = "Participación en Programas Educativos",
        subtitle = paste("Filtro:", input$population_filter),
        x = "",
        y = "Porcentaje"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        legend.position = "none",
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12)
      )
  })

  # Dropout Reasons Plot
  output$dropout_reasons_plot <- renderPlot({
    req(data())
    
    reasons <- c(
      "01" = "No quise/No me interesa",
      "02" = "Dificultad académica",
      "03" = "Otras actividades",
      "04" = "Actividades ilegales",
      "05" = "Falta de dinero",
      "06" = "Expulsión",
      "07" = "Trabajo",
      "08" = "Falta de documentos",
      "09" = "Matrimonio/Embarazo",
      "10" = "Detención",
      "11" = "Salida de cárcel",
      "12" = "Labores del hogar",
      "13" = "Salud",
      "14" = "Adicciones"
    )
    
    plot_data <- data() %>%
      count(P1_21) %>%
      mutate(
        reason = reasons[P1_21],
        percentage = n/sum(n) * 100
      ) %>%
      arrange(desc(percentage))
    
    ggplot(plot_data, aes(x = reorder(reason, percentage), y = percentage)) +
      geom_bar(stat = "identity", fill = "#2E86C1", width = 0.7) +
      geom_text(aes(label = sprintf("%.1f%%", percentage)),
                hjust = -0.2) +
      scale_y_continuous(limits = c(0, max(plot_data$percentage) * 1.2)) +
      coord_flip() +
      labs(
        title = "Razones para Abandonar los Estudios",
        subtitle = paste("Filtro:", input$population_filter),
        x = "",
        y = "Porcentaje"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12)
      )
  })

  # Enhanced table outputs
  output$education_level_table <- renderDT({
    req(data())
    
    # Define education levels mapping
    education_levels <- c(
      "0" = "Sin educación",
      "1" = "Preescolar",
      "2" = "Primaria", 
      "3" = "Secundaria",
      "4" = "Carrera técnica (secundaria)",
      "5" = "Normal básica",
      "6" = "Preparatoria",
      "7" = "Carrera técnica (preparatoria)", 
      "8" = "Licenciatura",
      "9" = "Posgrado",
      "98" = "No sabe",
      "99" = "No responde"
    )
    
    data() %>%
      count(P1_18_N) %>%
      mutate(
        Nivel = case_when(
          as.character(P1_18_N) %in% names(education_levels) ~ education_levels[as.character(P1_18_N)],
          TRUE ~ "No especificado"
        ),
        Cantidad = n,
        Porcentaje = sprintf("%.1f%%", n/sum(n) * 100)
      ) %>%
      select(Nivel, Cantidad, Porcentaje) %>%
      arrange(desc(Cantidad)) %>%
      datatable(
        options = list(
          pageLength = 10,
          dom = 't',
          ordering = FALSE
        ),
        rownames = FALSE
      )
  })

  output$prison_education_table <- renderDT({
    req(data())
    
    data() %>%
      count(P1_19) %>%
      mutate(
        Status = case_when(
          P1_19 == "1" ~ "Estudiando",
          P1_19 == "2" ~ "No estudiando",
          TRUE ~ "Sin información"
        ),
        Porcentaje = n/sum(n) * 100,
        Porcentaje = sprintf("%.1f%%", Porcentaje)
      ) %>%
      select(Status, n, Porcentaje) %>%
      datatable(
        options = list(
          pageLength = 10,
          dom = 't',
          ordering = FALSE
        ),
        rownames = FALSE
      )
  })

  output$dropout_reasons_table <- renderDT({
    req(data())
    
    data() %>%
      count(P1_21) %>%
      mutate(
        Porcentaje = n/sum(n) * 100,
        Porcentaje = sprintf("%.1f%%", Porcentaje)
      ) %>%
      datatable(
        options = list(
          pageLength = 10,
          dom = 't',
          ordering = FALSE
        ),
        rownames = FALSE
      )
  })
}

shinyApp(ui = ui, server = server)
```
